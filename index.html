<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sessionly — app</title>
  <meta name="description" content="Sessionly app: log trades, track sessions, improve performance." />
  <style>
    :root{
      --bg:#0b0f14;
      --card:#101826;
      --text:#e8eef7;
      --muted:#a8b3c5;
      --accent:#3ddc97;
      --danger:#ff5b5b;
      --line:#22304a;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helveticaica,Arial;background:
      radial-gradient(1100px 700px at 15% -10%, rgba(61,220,151,.15), transparent 55%),
      radial-gradient(900px 600px at 85% 10%, rgba(80,120,255,.14), transparent 60%),
      radial-gradient(800px 600px at 50% 120%, rgba(61,220,151,.08), transparent 55%),
      var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 16px rgba(61,220,151,.55)}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:10px 14px;border-radius:999px;color:var(--muted);background:rgba(16,24,38,.6)}
    .btn{border:1px solid var(--line);background:rgba(16,24,38,.7);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn:hover{border-color:rgba(61,220,151,.5)}
    .btn.primary{background:var(--accent);border-color:transparent;color:#052014}
    .btn.danger{background:rgba(255,91,91,.14);border-color:rgba(255,91,91,.35);color:#ffd6d6}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media(min-width:980px){.grid{grid-template-columns: 420px 1fr}}
    .card{background:linear-gradient(180deg, rgba(16,24,38,.85), rgba(16,24,38,.65));
      border:1px solid rgba(34,48,74,.9);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{margin:0 0 10px;font-size:18px}
    .card .inner{padding:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px;flex:1}
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      background:rgba(11,15,20,.55);
      border:1px solid rgba(34,48,74,.9);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:88px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(61,220,151,.5);box-shadow:0 0 0 3px rgba(61,220,151,.12)}
    .hr{height:1px;background:rgba(34,48,74,.9);margin:14px 0}
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:980px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{padding:12px;border:1px solid rgba(34,48,74,.9);border-radius:14px;background:rgba(11,15,20,.35)}
    .kpi .big{font-size:20px;font-weight:900}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px 10px;border-bottom:1px solid rgba(34,48,74,.7);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700}
    .tag{display:inline-flex;align-items:center;border:1px solid rgba(34,48,74,.9);padding:5px 9px;border-radius:999px;color:var(--muted);background:rgba(11,15,20,.35);font-size:12px}
    .right{margin-left:auto}
    .msg{margin-top:10px;font-size:13px}
    .ok{color:#bff3dc}
    .err{color:#ffd0d0}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand"><span class="dot"></span> Sessionly <span class="pill">app</span></div>
      <div class="row">
        <span id="userPill" class="pill hidden"></span>
        <button id="logoutBtn" class="btn danger hidden">log out</button>
      </div>
    </div>

    <div class="grid">
      <!-- AUTH / ADD TRADE -->
      <div class="card">
        <div class="inner">
          <div id="authBox">
            <h2>login</h2>
            <div class="row">
              <div class="field">
                <label>email</label>
                <input id="email" type="email" placeholder="you@email.com" autocomplete="email" />
              </div>
              <div class="field">
                <label>password</label>
                <input id="password" type="password" placeholder="min 6 characters" autocomplete="current-password" />
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <button id="loginBtn" class="btn primary">login</button>
              <button id="signupBtn" class="btn">create account</button>
            </div>
            <div class="msg muted">accounts are free for now</div>
            <div id="authMsg" class="msg"></div>

            <div class="hr"></div>
            <div class="muted" style="font-size:12px">
              if you just signed up, check your email and confirm. after confirming you can come back here and log in.
            </div>
          </div>

          <div id="tradeBox" class="hidden">
            <h2>add trade</h2>
            <div class="row">
              <div class="field">
                <label>date</label>
                <input id="trade_date" type="date" />
              </div>
              <div class="field">
                <label>symbol</label>
                <input id="symbol" placeholder="XAUUSD" />
              </div>
              <div class="field">
                <label>direction</label>
                <select id="direction">
                  <option value="long">long</option>
                  <option value="short">short</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>rr</label>
                <input id="rr" type="number" step="0.01" placeholder="2.0" />
              </div>
              <div class="field">
                <label>pnl ($)</label>
                <input id="pnl" type="number" step="0.01" placeholder="100" />
              </div>
              <div class="field">
                <label>session</label>
                <select id="session">
                  <option value="london">london</option>
                  <option value="newyork">new york</option>
                  <option value="asia">asia</option>
                  <option value="other">other</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>mistake tags (comma separated)</label>
                <input id="tags" placeholder="overtrade,fomo,bad entry" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>notes</label>
                <textarea id="notes" placeholder="what happened, what to fix next time"></textarea>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button id="addTradeBtn" class="btn primary">save trade</button>
              <span id="tradeMsg" class="msg muted right"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div class="card">
        <div class="inner">
          <div class="row">
            <h2 style="margin:0">dashboard</h2>
            <span id="dashStatus" class="msg muted right"></span>
          </div>

          <div class="kpis" style="margin-top:12px">
            <div class="kpi">
              <div class="muted">trades</div>
              <div id="k_trades" class="big">0</div>
            </div>
            <div class="kpi">
              <div class="muted">win rate</div>
              <div id="k_wr" class="big">0%</div>
            </div>
            <div class="kpi">
              <div class="muted">total pnl</div>
              <div id="k_pnl" class="big">$0</div>
            </div>
            <div class="kpi">
              <div class="muted">best session</div>
              <div id="k_best" class="big">—</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="margin-bottom:10px">
            <span class="tag">latest trades</span>
            <span class="muted right" style="font-size:12px">only you can see your data</span>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>date</th>
                  <th>symbol</th>
                  <th>dir</th>
                  <th>session</th>
                  <th>rr</th>
                  <th>pnl</th>
                  <th>tags</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div id="dashMsg" class="msg muted" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://oucikdsngvdhimquclcz.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_gMETcAB_TRLGd8hqx48KRA_yXxE7U6v";

    // IMPORTANT: confirmation redirect target
    const CONFIRM_REDIRECT = "https://wwjk-bot.github.io/confirm.html";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== UI HELPERS ======
    const el = (id) => document.getElementById(id);
    const setMsg = (id, text, type="") => {
      const node = el(id);
      node.textContent = text || "";
      node.className = "msg " + (type === "ok" ? "ok" : type === "err" ? "err" : "");
    };
    const show = (id) => el(id).classList.remove("hidden");
    const hide = (id) => el(id).classList.add("hidden");

    // ====== AUTH ======
    async function refreshSession() {
      const { data: { session } } = await supabaseClient.auth.getSession();

      if (!session) {
        hide("userPill");
        hide("logoutBtn");
        show("authBox");
        hide("tradeBox");
        el("rows").innerHTML = "";
        el("k_trades").textContent = "0";
        el("k_wr").textContent = "0%";
        el("k_pnl").textContent = "$0";
        el("k_best").textContent = "—";
        setMsg("dashMsg", "log in to see your trades");
        return;
      }

      el("userPill").textContent = session.user.email;
      show("userPill");
      show("logoutBtn");
      hide("authBox");
      show("tradeBox");

      await loadTrades();
    }

    el("loginBtn").addEventListener("click", async () => {
      setMsg("authMsg", "logging in...");
      const email = el("email").value.trim();
      const password = el("password").value;

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) { setMsg("authMsg", error.message, "err"); return; }

      setMsg("authMsg", "logged in", "ok");
      await refreshSession();
    });

    el("signupBtn").addEventListener("click", async () => {
      setMsg("authMsg", "creating account...");
      const email = el("email").value.trim();
      const password = el("password").value;

      const { error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          // THIS IS THE KEY PART (STEP 2)
          emailRedirectTo: CONFIRM_REDIRECT
        }
      });

      if (error) { setMsg("authMsg", error.message, "err"); return; }

      setMsg("authMsg", "check your email to confirm, then come back and log in", "ok");
    });

    el("logoutBtn").addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      await refreshSession();
    });

    // ====== TRADES ======
    function computeStats(trades) {
      const n = trades.length;
      el("k_trades").textContent = String(n);

      if (!n) {
        el("k_wr").textContent = "0%";
        el("k_pnl").textContent = "$0";
        el("k_best").textContent = "—";
        return;
      }

      let wins = 0;
      let totalPnl = 0;

      const bySession = {};
      for (const t of trades) {
        const pnl = Number(t.pnl || 0);
        totalPnl += pnl;
        if (pnl > 0) wins++;

        const s = t.session || "other";
        bySession[s] = (bySession[s] || 0) + pnl;
      }

      const wr = Math.round((wins / n) * 100);
      el("k_wr").textContent = wr + "%";
      el("k_pnl").textContent = (totalPnl >= 0 ? "$" : "-$") + Math.abs(totalPnl).toFixed(2);

      let best = "—";
      let bestVal = -Infinity;
      for (const k in bySession) {
        if (bySession[k] > bestVal) { bestVal = bySession[k]; best = k; }
      }
      el("k_best").textContent = best;
    }

    function renderTrades(trades) {
      const rows = el("rows");
      rows.innerHTML = "";

      for (const t of trades) {
        const tr = document.createElement("tr");

        const tags = Array.isArray(t.tags) ? t.tags.join(", ") : (t.tags || "");
        const rr = (t.rr === null || t.rr === undefined || t.rr === "") ? "" : Number(t.rr).toFixed(2);
        const pnl = (t.pnl === null || t.pnl === undefined || t.pnl === "") ? "" : Number(t.pnl).toFixed(2);

        tr.innerHTML = `
          <td>${t.trade_date || ""}</td>
          <td>${escapeHtml(t.symbol || "")}</td>
          <td>${escapeHtml(t.direction || "")}</td>
          <td>${escapeHtml(t.session || "")}</td>
          <td>${rr}</td>
          <td>${pnl}</td>
          <td>${escapeHtml(tags)}</td>
        `;
        rows.appendChild(tr);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    async function loadTrades() {
      setMsg("dashStatus", "loading...");
      const { data, error } = await supabaseClient
        .from("trades")
        .select("*")
        .order("trade_date", { ascending: false })
        .order("created_at", { ascending: false })
        .limit(50);

      if (error) {
        setMsg("dashStatus", "");
        setMsg("dashMsg", error.message, "err");
        return;
      }

      computeStats(data || []);
      renderTrades(data || []);
      setMsg("dashStatus", "");
      setMsg("dashMsg", (data && data.length) ? "" : "no trades yet, add your first trade on the left");
    }

    el("addTradeBtn").addEventListener("click", async () => {
      setMsg("tradeMsg", "saving...");
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { setMsg("tradeMsg", "please log in first", "err"); return; }

      const tagsRaw = el("tags").value.trim();
      const tags = tagsRaw ? tagsRaw.split(",").map(x => x.trim()).filter(Boolean) : [];

      const payload = {
        user_id: session.user.id,
        trade_date: el("trade_date").value || null,
        symbol: el("symbol").value.trim() || null,
        direction: el("direction").value,
        rr: el("rr").value === "" ? null : Number(el("rr").value),
        pnl: el("pnl").value === "" ? null : Number(el("pnl").value),
        session: el("session").value,
        tags,
        notes: el("notes").value.trim() || null
      };

      const { error } = await supabaseClient.from("trades").insert(payload);
      if (error) { setMsg("tradeMsg", error.message, "err"); return; }

      setMsg("tradeMsg", "saved", "ok");

      // reset light
      el("symbol").value = "";
      el("rr").value = "";
      el("pnl").value = "";
      el("tags").value = "";
      el("notes").value = "";

      await loadTrades();
      setTimeout(()=>setMsg("tradeMsg",""), 1500);
    });

    // react to auth changes
    supabaseClient.auth.onAuthStateChange(() => refreshSession());

    // initial
    refreshSession();
  </script>
</body>
</html>
