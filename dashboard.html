<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sessionly - dashboard</title>
  <meta name="description" content="Sessionly dashboard" />
  <style>
    :root{
      --bg:#070a10;
      --panel:#0b1220;
      --panel2:#0a1324;
      --card: rgba(14,22,38,.92);
      --card2: rgba(10,18,32,.75);
      --text:#e8eef7;
      --muted:#a8b3c5;
      --line: rgba(70,90,135,.32);
      --line2: rgba(70,90,135,.20);

      --accent:#7c4dff;
      --accent2:#3ddc97;

      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;
    }

    /* light theme overrides */
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:#ffffff;
      --panel2:#f6f8ff;
      --card: rgba(255,255,255,.92);
      --card2: rgba(255,255,255,.76);
      --text:#0b1220;
      --muted:#4d5b72;
      --line: rgba(20,40,80,.14);
      --line2: rgba(20,40,80,.10);
      --shadow: 0 18px 70px rgba(10,20,60,.14);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 0%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 60%),
        radial-gradient(900px 520px at 78% 14%, color-mix(in srgb, var(--accent2) 12%, transparent), transparent 60%),
        radial-gradient(1100px 700px at 50% 100%, rgba(0,0,0,.25), transparent 65%),
        var(--bg);
    }

    a{color:inherit}
    .layout{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr;}
      .sidebar{position:sticky; top:0; z-index:30;}
    }

    .sidebar{
      padding:18px 16px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 92%, transparent), color-mix(in srgb, var(--panel) 78%, transparent));
      border-right: 1px solid var(--line2);
      backdrop-filter: blur(10px);
    }

    .brandRow{display:flex; align-items:center; gap:10px; margin-bottom:12px;}
    .logoDot{
      width:12px; height:12px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 7px color-mix(in srgb, var(--accent) 18%, transparent);
    }
    .brand{font-weight:900; letter-spacing:.2px;}
    .signed{color:var(--muted); font-size:13px; margin:6px 0 16px 0; line-height:1.35;}
    .nav{
      display:flex; flex-direction:column; gap:8px;
      margin-bottom:14px;
    }

    .navBtn{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--panel2) 78%, transparent);
      text-decoration:none;
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .navBtn:hover{ transform: translateY(-1px); border-color: var(--line); }
    .navBtn.active{
      background: color-mix(in srgb, var(--accent) 18%, var(--panel2));
      border-color: color-mix(in srgb, var(--accent) 40%, var(--line));
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
    }
    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      color: color-mix(in srgb, var(--text) 85%, var(--muted));
      background: color-mix(in srgb, var(--bg) 40%, transparent);
      font-weight:800;
    }

    .sideActions{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .sideAction{
      width:100%;
      border-radius: 14px;
      padding:12px 12px;
      font-weight:900;
      border:1px solid var(--line2);
      background: transparent;
      color: var(--text);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .sideAction:hover{ transform: translateY(-1px); border-color: var(--line); background: color-mix(in srgb, var(--panel2) 35%, transparent); }

    .slogan{margin-top:14px; color:var(--muted); font-size:13px; line-height:1.4;}

    .main{
      padding:22px 22px 40px 22px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .shell{
      width:min(1120px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 84%, transparent), color-mix(in srgb, var(--panel) 66%, transparent));
      border: 1px solid var(--line2);
      box-shadow: var(--shadow);
      padding:20px;
      backdrop-filter: blur(12px);
    }

    .pageHead{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;}
    .titleWrap h1{margin:0; font-size:34px; letter-spacing:-.6px;}
    .titleWrap p{margin:6px 0 0 0; color:var(--muted); font-weight:700; font-size:14px;}
    .pill{
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--panel2) 58%, transparent);
      padding:7px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      color: color-mix(in srgb, var(--text) 86%, var(--muted));
      white-space:nowrap;
    }

    .ctaBar{
      margin-top:10px;
      display:flex; gap:10px; align-items:center;
      padding:12px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--panel2) 70%, transparent);
    }
    .ctaBtn{
      flex:1;
      padding:12px 14px;
      border-radius:999px;
      font-weight:950;
      border:1px solid transparent;
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 90%, #000), color-mix(in srgb, var(--accent) 65%, var(--accent2)));
      color:white;
      cursor:pointer;
      letter-spacing:.2px;
    }
    .ctaBtn:hover{ filter:brightness(1.05); }
    .ctaHint{color:var(--muted); font-size:13px; font-weight:800; padding:0 10px;}

    .grid4{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .grid4{grid-template-columns:1fr 1fr;} }
    @media (max-width: 560px){ .grid4{grid-template-columns:1fr;} }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--line2);
      background: var(--card);
      padding:16px;
    }
    .statLabel{
      font-size:12px;
      color: color-mix(in srgb, var(--muted) 85%, var(--text));
      font-weight:950;
      letter-spacing:.8px;
      text-transform:uppercase;
    }
    .statValue{
      font-size:28px;
      font-weight:980;
      margin-top:6px;
      letter-spacing:-.6px;
    }
    .statSub{
      margin-top:2px;
      color:var(--muted);
      font-size:13px;
      font-weight:750;
    }

    .row2{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .row2{grid-template-columns:1fr;} }

    .cardHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .cardTitle{
      font-size:18px;
      font-weight:950;
      margin:0;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size:14px;
    }
    th,td{
      text-align:left;
      padding:10px 8px;
      border-bottom:1px solid var(--line2);
    }
    th{
      color: color-mix(in srgb, var(--muted) 85%, var(--text));
      font-weight:950;
      font-size:12px;
      letter-spacing:.8px;
      text-transform:uppercase;
    }
    td{font-weight:750;}
    .muted{color:var(--muted); font-weight:750;}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .chip{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--panel2) 55%, transparent);
      font-weight:900;
      font-size:13px;
    }

    .ghostBtn{
      width:100%;
      margin-top:12px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: transparent;
      color:var(--text);
      font-weight:950;
      cursor:pointer;
    }
    .ghostBtn:hover{ background: color-mix(in srgb, var(--panel2) 35%, transparent); }

    /* analytics layout */
    .anaTop{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .anaTop{grid-template-columns:1fr;} }

    .anaGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .anaGrid{grid-template-columns:1fr;} }

    .fakeChart{
      min-height:240px;
      border-radius: var(--radius);
      border:1px dashed var(--line2);
      background: color-mix(in srgb, var(--card2) 60%, transparent);
      display:flex;
      align-items:center;
      justify-content:center;
      color: color-mix(in srgb, var(--muted) 92%, var(--text));
      font-weight:900;
      position:relative;
      overflow:hidden;
    }
    .chartTag{
      position:absolute;
      top:12px;
      right:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--bg) 45%, transparent);
      font-size:12px;
      font-weight:950;
      color: color-mix(in srgb, var(--text) 86%, var(--muted));
    }

    /* modal */
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius: 20px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--panel) 92%, transparent);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .modalHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .modalHead h2{margin:0; font-size:18px; font-weight:980;}
    .xBtn{
      border:1px solid var(--line2);
      background: transparent;
      color:var(--text);
      border-radius: 12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:980;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){ .formGrid{grid-template-columns:1fr;} }

    label{display:block; font-size:12px; font-weight:950; letter-spacing:.7px; text-transform:uppercase; color: color-mix(in srgb, var(--muted) 85%, var(--text)); margin:8px 0 6px;}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--bg) 18%, transparent);
      color:var(--text);
      font-weight:800;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical;}

    .modalFoot{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      margin-top:12px;
    }
    .btn{
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: transparent;
      color:var(--text);
      font-weight:980;
      cursor:pointer;
    }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 90%, #000), color-mix(in srgb, var(--accent) 65%, var(--accent2)));
      color:white;
    }
    .msg{margin-top:10px; font-weight:900; color:var(--muted); min-height:18px;}

    /* WOW: subtle motion + chart glow */
    @keyframes drawLine { from { stroke-dashoffset: var(--dash); } to { stroke-dashoffset: 0; } }
    @keyframes pulseLive { 0%{transform:scale(1);opacity:.55} 50%{transform:scale(1.25);opacity:.25} 100%{transform:scale(1);opacity:.55} }

    .pill.liveDot{position:relative; padding-left:26px;}
    .pill.liveDot::before{
      content:"";
      position:absolute;
      left:10px; top:50%;
      width:8px; height:8px;
      transform:translateY(-50%);
      border-radius:999px;
      background:var(--accent2);
      box-shadow:0 0 0 6px color-mix(in srgb, var(--accent2) 18%, transparent);
    }
    .pill.liveDot::after{
      content:"";
      position:absolute;
      left:10px; top:50%;
      width:8px; height:8px;
      transform:translateY(-50%);
      border-radius:999px;
      background:var(--accent2);
      animation:pulseLive 1.6s ease-in-out infinite;
      filter:blur(.2px);
    }

    .fakeChart.hasSvg{
      border-style:solid;
      border-color: color-mix(in srgb, var(--line) 65%, transparent);
      position:relative;
      overflow:hidden;
    }
    .fakeChart.hasSvg::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(900px 400px at 20% 10%, color-mix(in srgb, var(--accent) 14%, transparent), transparent 60%),
        radial-gradient(700px 360px at 80% 30%, color-mix(in srgb, var(--accent2) 12%, transparent), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }

    svg .gridline{ stroke: currentColor; opacity:.12; }
    svg .baseline{ stroke: currentColor; opacity:.20; }
    svg .bar{ fill: currentColor; opacity:.92; }
    svg .bar.dim{ opacity:.18; }
    svg .bar.best{ filter: drop-shadow(0 0 12px color-mix(in srgb, var(--accent2) 75%, transparent)); }
    svg .equity{
      fill:none;
      stroke:currentColor;
      stroke-width:2.8;
      opacity:.94;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    svg .equityBg{
      fill:none;
      stroke:currentColor;
      stroke-width:6;
      opacity:.10;
      stroke-linecap:round;
      stroke-linejoin:round;
    }

    /* small utility */
    .hide{display:none !important;}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brandRow">
        <span class="logoDot"></span>
        <div class="brand">Sessionly</div>
      </div>
      <div class="signed">
        signed in as <span id="userEmail">—</span>
      </div>

      <nav class="nav">
        <button class="navBtn" data-route="focus">
          <span>focus</span>
          <span class="tag">daily</span>
        </button>
        <button class="navBtn" data-route="analytics">
          <span>analytics</span>
          <span class="tag">charts</span>
        </button>
        <button class="navBtn" data-route="trades">
          <span>trades</span>
          <span class="tag">table</span>
        </button>
        <button class="navBtn" data-route="journal">
          <span>journal</span>
          <span class="tag">notes</span>
        </button>
      </nav>

      <div class="sideActions">
        <button class="sideAction" id="toggleThemeBtn">toggle theme</button>
        <button class="sideAction" id="logoutBtn">log out</button>
      </div>

      <div class="slogan">calm by default, deep when you want it</div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="shell">

        <!-- FOCUS PAGE -->
        <section id="page-focus" class="page">
          <div class="pageHead">
            <div class="titleWrap">
              <h1>focus</h1>
              <p>your daily view, clean and calm</p>

              <div class="ctaBar">
                <button class="ctaBtn" id="addTradeBtn1">+ add trade</button>
                <div class="ctaHint">log fast, review later</div>
              </div>
            </div>
            <span class="pill" id="focusStatusPill">ready</span>
          </div>

          <div class="grid4">
            <div class="card">
              <div class="statLabel">recent trades loaded</div>
              <div class="statValue" id="focusTradesCount">—</div>
              <div class="statSub" id="focusTradesSub">last 8 trades</div>
            </div>
            <div class="card">
              <div class="statLabel">win rate</div>
              <div class="statValue" id="focusWinRate">—</div>
              <div class="statSub">wins / last 8 trades</div>
            </div>
            <div class="card">
              <div class="statLabel">total r</div>
              <div class="statValue" id="focusTotalR">—</div>
              <div class="statSub">sum r multiple</div>
            </div>
            <div class="card">
              <div class="statLabel">avg rr</div>
              <div class="statValue" id="focusAvgRR">—</div>
              <div class="statSub">average rr</div>
            </div>
          </div>

          <div class="row2">
            <div class="card">
              <div class="cardHead">
                <h3 class="cardTitle">recent trades</h3>
                <span class="pill" id="focusTradesPill">ready</span>
              </div>

              <div class="muted" id="focusTradesMsg" style="margin:0 0 10px 0;"></div>

              <table>
                <thead>
                  <tr>
                    <th>date</th>
                    <th>symbol</th>
                    <th>dir</th>
                    <th>rr</th>
                    <th>r</th>
                  </tr>
                </thead>
                <tbody id="focusTradesBody">
                  <tr><td colspan="5" class="muted">no trades yet, add your first one</td></tr>
                </tbody>
              </table>
            </div>

            <div class="card">
              <div class="cardHead">
                <h3 class="cardTitle">today’s focus</h3>
                <span class="pill">coach</span>
              </div>
              <div style="font-weight:900; line-height:1.45;">
                log the next trade immediately after closing it, and write one sentence on why you entered
              </div>

              <div class="chips">
                <span class="chip">session ny</span>
                <span class="chip">rule max 3 trades</span>
                <span class="chip">goal no revenge</span>
              </div>

              <div class="muted" style="margin-top:10px; font-weight:800;">
                next we’ll generate this from your real patterns and mistakes, for now it’s a placeholder
              </div>

              <button class="ghostBtn" id="refreshBtn1">refresh stats</button>
            </div>
          </div>
        </section>

        <!-- ANALYTICS PAGE -->
        <section id="page-analytics" class="page hide">
          <div class="pageHead">
            <div class="titleWrap">
              <h1>analytics</h1>
              <p>deep data lives here, focus stays clean</p>
            </div>
            <span class="pill liveDot">live</span>
          </div>

          <div class="anaTop">
            <div class="card">
              <div class="statLabel">profit factor</div>
              <div class="statValue" id="anaPF">—</div>
              <div class="statSub" id="anaPFSub">from 0 trades</div>
            </div>
            <div class="card">
              <div class="statLabel">avg win vs avg loss</div>
              <div class="statValue" id="anaWinLoss">—</div>
              <div class="statSub">avg win r vs avg loss r</div>
            </div>
            <div class="card">
              <div class="statLabel">best hour</div>
              <div class="statValue" id="anaBestHour">—</div>
              <div class="statSub" id="anaBestHourSub">avg r —</div>
            </div>
          </div>

          <div class="anaGrid">
            <div class="card">
              <div class="cardHead">
                <h3 class="cardTitle">pnl by day (calendar)</h3>
                <span class="pill">visual</span>
              </div>
              <div class="fakeChart" id="calendarChart">
                calendar view placeholder
              </div>
            </div>

            <div class="card">
              <div class="cardHead">
                <h3 class="cardTitle">hourly performance</h3>
                <span class="pill">sessionly</span>
              </div>
              <div class="fakeChart hasSvg" id="hourlyChart">
                bar chart placeholder
              </div>
            </div>

            <div class="card">
              <div class="cardHead">
                <h3 class="cardTitle">win vs loss distribution</h3>
                <span class="pill">edge</span>
              </div>
              <div class="fakeChart" id="distChart">
                distribution placeholder
              </div>
            </div>

            <div class="card">
              <div class="cardHead">
                <h3 class="cardTitle">equity curve</h3>
                <span class="pill">trend</span>
              </div>
              <div class="fakeChart hasSvg" id="equityChart">
                equity curve will appear after 2+ trades
              </div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px; font-weight:800;">
            once you log trades here, we’ll build real charts from your dataset
          </div>

          <button class="ghostBtn" id="refreshBtn2">refresh stats</button>
        </section>

        <!-- TRADES PAGE -->
        <section id="page-trades" class="page hide">
          <div class="pageHead">
            <div class="titleWrap">
              <h1>trades</h1>
              <p>your full table, filter later</p>
              <div class="ctaBar">
                <button class="ctaBtn" id="addTradeBtn2">+ add trade</button>
                <div class="ctaHint">every trade is a data point</div>
              </div>
            </div>
            <span class="pill" id="tradesCountPill">—</span>
          </div>

          <div class="card">
            <div class="cardHead">
              <h3 class="cardTitle">all trades</h3>
              <span class="pill">table</span>
            </div>

            <div class="muted" id="tradesMsg" style="margin:0 0 10px 0;"></div>

            <table>
              <thead>
                <tr>
                  <th>date</th>
                  <th>symbol</th>
                  <th>dir</th>
                  <th>session</th>
                  <th>strategy</th>
                  <th>rr</th>
                  <th>r</th>
                </tr>
              </thead>
              <tbody id="tradesBody">
                <tr><td colspan="7" class="muted">loading…</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- JOURNAL PAGE -->
        <section id="page-journal" class="page hide">
          <div class="pageHead">
            <div class="titleWrap">
              <h1>journal</h1>
              <p>notes that turn into rules</p>
            </div>
            <span class="pill">coming next</span>
          </div>

          <div class="card">
            <div class="cardHead">
              <h3 class="cardTitle">quick note</h3>
              <span class="pill">placeholder</span>
            </div>
            <div class="muted" style="font-weight:800; line-height:1.5;">
              this is where your daily notes, rules, and “what I learned” will live
            </div>

            <label style="margin-top:12px;">today’s note</label>
            <textarea id="journalNote" placeholder="write one thing you’ll do differently next session…"></textarea>
            <button class="ghostBtn" id="journalSaveBtn">save (local only for now)</button>
            <div class="msg" id="journalMsg"></div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- ADD TRADE MODAL -->
  <div class="backdrop" id="tradeBackdrop">
    <div class="modal">
      <div class="modalHead">
        <h2>add trade</h2>
        <button class="xBtn" id="closeTradeModal">close</button>
      </div>

      <div class="formGrid">
        <div>
          <label>date</label>
          <input id="t_date" type="datetime-local" />
        </div>
        <div>
          <label>symbol</label>
          <input id="t_symbol" placeholder="XAUUSD / NASDAQ / ES" />
        </div>

        <div>
          <label>direction</label>
          <select id="t_direction">
            <option value="long">long</option>
            <option value="short">short</option>
          </select>
        </div>
        <div>
          <label>session</label>
          <select id="t_session">
            <option value="">—</option>
            <option value="asia">asia</option>
            <option value="london">london</option>
            <option value="ny">ny</option>
          </select>
        </div>

        <div>
          <label>rr</label>
          <input id="t_rr" type="number" step="0.01" placeholder="1.5" />
        </div>
        <div>
          <label>r multiple</label>
          <input id="t_r" type="number" step="0.01" placeholder="1.0 (or -1.0)" />
        </div>

        <div>
          <label>strategy</label>
          <input id="t_strategy" placeholder="fvg / breakout / etc" />
        </div>
        <div>
          <label>mistakes (comma separated)</label>
          <input id="t_mistakes" placeholder="revenge, late entry, overtrade" />
        </div>

        <div style="grid-column:1/-1;">
          <label>notes</label>
          <textarea id="t_notes" placeholder="one sentence why you entered…"></textarea>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn" id="cancelTradeBtn">cancel</button>
        <button class="btn primary" id="saveTradeBtn">save trade</button>
      </div>
      <div class="msg" id="tradeMsg"></div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://oucikdsngvdhimquclcz.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_gMETcAB_TRLGd8hqx48KRA_yXxE7U6v";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== THEME ======
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("sessionly_theme", theme);
    }
    function initTheme(){
      const saved = localStorage.getItem("sessionly_theme");
      applyTheme(saved || "dark");
    }

    // ====== ROUTING ======
    const pages = ["focus","analytics","trades","journal"];
    function setRoute(route){
      if (!pages.includes(route)) route = "focus";
      location.hash = route;
      renderRoute();
    }
    function renderRoute(){
      const route = (location.hash || "#focus").replace("#","");
      pages.forEach(p=>{
        document.getElementById("page-"+p).classList.toggle("hide", p !== route);
      });
      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.route === route);
      });
    }

    // ====== UTIL ======
    function fmtDate(d){
      try{
        const dt = new Date(d);
        return dt.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"});
      }catch(e){ return "—"; }
    }
    function fmtHourLabel(h){
      const hh = String(h).padStart(2,"0");
      return `${hh}:00`;
    }
    function setText(id, v){
      const el = document.getElementById(id);
      if (el) el.textContent = v;
    }
    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    // ====== DATA ======
    let user = null;
    let trades = []; // normalized: {trade_date, symbol, direction, rr, r, session, strategy, notes, created_at}

    async function requireAuth(){
      const { data } = await sb.auth.getSession();
      const session = data.session;
      if (!session){
        // send to login page
        window.location.href = "login.html";
        return null;
      }
      user = session.user;
      setText("userEmail", user.email || "—");
      return user;
    }

    async function loadTrades(){
      if (!user) return [];

      // IMPORTANT: your DB uses columns like rr, r_multiple (or maybe r_multiple + rr)
      // We'll try to select both rr + r_multiple and also r (fallback), session, strategy, mistakes, notes.
      const { data, error } = await sb
        .from("trades")
        .select("id, trade_date, symbol, direction, rr, r_multiple, session, strategy, mistakes, notes, created_at")
        .order("trade_date", { ascending: false });

      if (error){
        console.log("loadTrades error", error);
        return [];
      }

      return (data || []).map(t => ({
        id: t.id,
        trade_date: t.trade_date,
        symbol: t.symbol || "—",
        direction: t.direction || "—",
        rr: t.rr,
        r: (t.r_multiple ?? null),
        session: t.session || "",
        strategy: t.strategy || "",
        mistakes: t.mistakes || [],
        notes: t.notes || "",
        created_at: t.created_at
      }));
    }

    // ====== STATS ======
    function computeAnalytics(all){
      const clean = (all || []).map(t => ({
        date: t.trade_date,
        rr: safeNum(t.rr),
        r: safeNum(t.r),
        hour: (()=>{ try{ return new Date(t.trade_date).getHours(); }catch(e){ return null; } })()
      }));

      const wins = clean.filter(t => t.r > 0);
      const losses = clean.filter(t => t.r < 0);

      const sumWin = wins.reduce((a,b)=>a + b.r, 0);
      const sumLossAbs = losses.reduce((a,b)=>a + Math.abs(b.r), 0);

      const pf = (sumLossAbs === 0) ? Infinity : (sumWin / sumLossAbs);

      const avgWin = wins.length ? (sumWin / wins.length) : NaN;
      const avgLoss = losses.length ? (sumLossAbs / losses.length) : NaN;

      // hourly bucket avg r
      const byHour = new Map();
      clean.forEach(t=>{
        if (t.hour === null) return;
        const o = byHour.get(t.hour) || { sum:0, n:0 };
        o.sum += t.r;
        o.n += 1;
        byHour.set(t.hour, o);
      });

      // best hour by avg r
      let bestHour = null;
      let bestHourAvg = -Infinity;
      byHour.forEach((o, h)=>{
        const avg = o.sum / o.n;
        if (avg > bestHourAvg){
          bestHourAvg = avg;
          bestHour = h;
        }
      });

      // equity points (cumulative r in chronological order)
      const chrono = [...clean].sort((a,b)=> new Date(a.date) - new Date(b.date));
      let cum = 0;
      const points = chrono.map((t, i)=>{
        cum += t.r;
        return { x: i, y: cum };
      });

      return { clean, wins, losses, pf, avgWin, avgLoss, byHour, bestHour, bestHourAvg, points };
    }

    function refreshFocus(){
      // focus uses last 8 trades
      const last = trades.slice(0, 8);
      const a = computeAnalytics(last);

      setText("focusTradesCount", String(last.length));
      setText("focusTradesSub", "last 8 trades");

      const winRate = last.length ? (a.wins.length / last.length) * 100 : NaN;
      setText("focusWinRate", last.length ? `${winRate.toFixed(1)}%` : "—");

      const totalR = a.clean.reduce((s,t)=>s+t.r,0);
      setText("focusTotalR", last.length ? totalR.toFixed(1) : "—");

      const avgRR = last.length ? (a.clean.reduce((s,t)=>s+t.rr,0) / last.length) : NaN;
      setText("focusAvgRR", last.length ? (Number.isFinite(avgRR) ? avgRR.toFixed(2) : "—") : "—");

      // table
      const body = document.getElementById("focusTradesBody");
      const msg = document.getElementById("focusTradesMsg");
      body.innerHTML = "";

      if (!last.length){
        body.innerHTML = `<tr><td colspan="5" class="muted">no trades yet, add your first one</td></tr>`;
        msg.textContent = "";
        return;
      }

      msg.textContent = "";
      last.forEach(t=>{
        body.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${fmtDate(t.trade_date)}</td>
            <td>${escapeHtml(t.symbol)}</td>
            <td>${escapeHtml(t.direction)}</td>
            <td>${Number.isFinite(Number(t.rr)) ? Number(t.rr).toFixed(2) : "—"}</td>
            <td>${Number.isFinite(Number(t.r)) ? Number(t.r).toFixed(2) : "—"}</td>
          </tr>
        `);
      });
    }

    function refreshTradesTable(){
      const pill = document.getElementById("tradesCountPill");
      pill.textContent = `${trades.length} trades`;

      const body = document.getElementById("tradesBody");
      const msg = document.getElementById("tradesMsg");
      body.innerHTML = "";

      if (!trades.length){
        body.innerHTML = `<tr><td colspan="7" class="muted">no trades yet, add your first one</td></tr>`;
        msg.textContent = "";
        return;
      }

      msg.textContent = "";
      trades.forEach(t=>{
        body.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${fmtDate(t.trade_date)}</td>
            <td>${escapeHtml(t.symbol)}</td>
            <td>${escapeHtml(t.direction)}</td>
            <td>${escapeHtml(t.session || "—")}</td>
            <td>${escapeHtml(t.strategy || "—")}</td>
            <td>${Number.isFinite(Number(t.rr)) ? Number(t.rr).toFixed(2) : "—"}</td>
            <td>${Number.isFinite(Number(t.r)) ? Number(t.r).toFixed(2) : "—"}</td>
          </tr>
        `);
      });
    }

    function refreshAnalytics(){
      const a = computeAnalytics(trades);

      // profit factor (no ∞)
      const hasWin = a.clean.some(x => x.r > 0);
      const hasLoss = a.clean.some(x => x.r < 0);
      const pfText = (hasWin && hasLoss && !Number.isNaN(a.pf) && Number.isFinite(a.pf)) ? a.pf.toFixed(2) : "—";
      setText("anaPF", pfText);
      setText("anaPFSub", `from ${trades.length} trades`);

      // avg win vs avg loss
      if (hasWin && hasLoss){
        const wl = `${a.avgWin.toFixed(2)} vs ${a.avgLoss.toFixed(2)}`;
        setText("anaWinLoss", wl);
      } else {
        setText("anaWinLoss", "—");
      }

      // best hour
      if (a.bestHour !== null && Number.isFinite(a.bestHourAvg)){
        setText("anaBestHour", fmtHourLabel(a.bestHour));
        setText("anaBestHourSub", `avg r ${a.bestHourAvg.toFixed(2)}`);
      } else {
        setText("anaBestHour", "—");
        setText("anaBestHourSub", "avg r —");
      }

      // draw charts
      drawHourlyBars(a.byHour);
      drawEquitySVG(a.points);
    }

    // ====== WOW CHARTS ======
    function drawEquitySVG(points){
      const el = document.getElementById("equityChart");
      if (!el) return;

      if (!points || points.length < 2){
        el.classList.remove("hasSvg");
        el.textContent = "equity curve will appear after 2+ trades";
        return;
      }

      const w = 640, h = 220, pad = 18;

      const ys = points.map(p => p.y);
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const span = (maxY - minY) || 1;

      const toX = (i) => pad + (i * (w - pad*2) / (points.length - 1));
      const toY = (y) => pad + ((maxY - y) * (h - pad*2) / span);

      let d = `M ${toX(0)} ${toY(points[0].y)}`;
      for (let i=1;i<points.length;i++) d += ` L ${toX(i)} ${toY(points[i].y)}`;

      el.classList.add("hasSvg");
      el.innerHTML = `
        <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="none">
          ${[0.25,0.5,0.75].map(t=>{
            const y = pad + t*(h-pad*2);
            return `<line class="gridline" x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}"></line>`;
          }).join("")}
          <path class="equityBg" d="${d}"></path>
          <path class="equity" id="equityPath" d="${d}"></path>
        </svg>
      `;
      el.style.color = "var(--accent2)";

      const path = document.getElementById("equityPath");
      if (!path) return;

      const len = path.getTotalLength();
      path.style.setProperty("--dash", len);
      path.style.strokeDasharray = String(len);
      path.style.strokeDashoffset = String(len);
      path.style.animation = "drawLine 900ms cubic-bezier(.2,.9,.2,1) forwards";
    }

    function drawHourlyBars(byHour){
      const el = document.getElementById("hourlyChart");
      if (!el) return;

      const hours = Array.from({length:24}, (_,i)=>i);
      const vals = hours.map(h=>{
        const o = byHour.get(h);
        return o ? (o.sum / o.n) : 0;
      });

      const hasAny = vals.some(v => v !== 0);
      if (!hasAny){
        el.classList.remove("hasSvg");
        el.textContent = "hourly performance will appear after you have trades across hours";
        return;
      }

      const w = 640, h = 220, pad = 18;
      const maxAbs = Math.max(...vals.map(v=>Math.abs(v))) || 1;
      const barW = (w - pad*2) / 24;
      const midY = h/2;

      let bestIdx = 0;
      let bestScore = -Infinity;
      vals.forEach((v,i)=>{
        const score = Math.abs(v);
        if (score > bestScore){ bestScore = score; bestIdx = i; }
      });

      const bars = vals.map((v, i)=>{
        const x = pad + i*barW + 2;
        const bw = Math.max(2, barW - 4);
        const bh = (Math.abs(v) / maxAbs) * (h/2 - pad);
        const cls = [
          "bar",
          (v === 0 ? "dim" : ""),
          (i === bestIdx ? "best" : "")
        ].join(" ").trim();

        return `<rect class="${cls}" data-bh="${bh}" data-v="${v}" x="${x}" y="${midY}" width="${bw}" height="0" rx="4"></rect>`;
      }).join("");

      el.classList.add("hasSvg");
      el.innerHTML = `
        <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="none">
          ${[0.25,0.5,0.75].map(t=>{
            const y = pad + t*(h-pad*2);
            return `<line class="gridline" x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}"></line>`;
          }).join("")}
          <line class="baseline" x1="${pad}" y1="${midY}" x2="${w-pad}" y2="${midY}"></line>
          <g id="bars">${bars}</g>
        </svg>
      `;
      el.style.color = "var(--accent)";

      const rects = el.querySelectorAll("rect.bar");
      const start = performance.now();
      const dur = 700;
      function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

      function tick(now){
        const t = Math.min(1, (now - start) / dur);
        const k = easeOutCubic(t);

        rects.forEach(r=>{
          const bh = Number(r.getAttribute("data-bh")) || 0;
          const v = Number(r.getAttribute("data-v")) || 0;
          const targetH = bh * k;

          if (v >= 0){
            r.setAttribute("y", String(midY - targetH));
            r.setAttribute("height", String(targetH));
          } else {
            r.setAttribute("y", String(midY));
            r.setAttribute("height", String(targetH));
          }
        });

        if (t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    // ====== INSERT TRADE ======
    function openTradeModal(){
      const bd = document.getElementById("tradeBackdrop");
      bd.style.display = "flex";
      setText("tradeMsg", "");

      // default date = now
      const now = new Date();
      const iso = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      document.getElementById("t_date").value = iso;
      document.getElementById("t_symbol").focus();
    }
    function closeTradeModal(){
      document.getElementById("tradeBackdrop").style.display = "none";
    }

    async function saveTrade(){
      const msg = document.getElementById("tradeMsg");
      msg.textContent = "saving…";

      const trade_date = document.getElementById("t_date").value;
      const symbol = document.getElementById("t_symbol").value.trim();
      const direction = document.getElementById("t_direction").value;
      const session = document.getElementById("t_session").value;
      const rr = document.getElementById("t_rr").value;
      const r_multiple = document.getElementById("t_r").value;
      const strategy = document.getElementById("t_strategy").value.trim();
      const mistakesRaw = document.getElementById("t_mistakes").value.trim();
      const notes = document.getElementById("t_notes").value.trim();

      if (!trade_date){
        msg.textContent = "please choose a date";
        return;
      }
      if (!symbol){
        msg.textContent = "please add a symbol";
        return;
      }

      const mistakes = mistakesRaw
        ? mistakesRaw.split(",").map(s=>s.trim()).filter(Boolean)
        : [];

      const payload = {
        user_id: user.id,
        trade_date: new Date(trade_date).toISOString(),
        symbol,
        direction,
        session: session || null,
        strategy: strategy || null,
        mistakes: mistakes.length ? mistakes : null,
        rr: rr === "" ? null : Number(rr),
        r_multiple: r_multiple === "" ? null : Number(r_multiple),
        notes: notes || null
      };

      const { error } = await sb.from("trades").insert(payload);
      if (error){
        console.log("insert error", error);
        msg.textContent = "error saving trade: " + (error.message || "unknown");
        return;
      }

      msg.textContent = "saved";
      closeTradeModal();
      await fullRefresh();
    }

    // ====== JOURNAL LOCAL ======
    function loadJournal(){
      const saved = localStorage.getItem("sessionly_journal_note") || "";
      document.getElementById("journalNote").value = saved;
    }
    function saveJournal(){
      const v = document.getElementById("journalNote").value;
      localStorage.setItem("sessionly_journal_note", v);
      document.getElementById("journalMsg").textContent = "saved";
      setTimeout(()=> document.getElementById("journalMsg").textContent = "", 1200);
    }

    // ====== ESCAPE ======
    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[s]));
    }

    // ====== REFRESH ======
    async function fullRefresh(){
      trades = await loadTrades();

      refreshFocus();
      refreshAnalytics();
      refreshTradesTable();
    }

    // ====== INIT ======
    async function init(){
      initTheme();

      // nav
      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> setRoute(btn.dataset.route));
      });
      window.addEventListener("hashchange", renderRoute);

      document.getElementById("toggleThemeBtn").addEventListener("click", ()=>{
        const cur = document.documentElement.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
      });

      document.getElementById("logoutBtn").addEventListener("click", async ()=>{
        await sb.auth.signOut();
        window.location.href = "login.html";
      });

      // add trade buttons
      document.getElementById("addTradeBtn1").addEventListener("click", openTradeModal);
      document.getElementById("addTradeBtn2").addEventListener("click", openTradeModal);
      document.getElementById("closeTradeModal").addEventListener("click", closeTradeModal);
      document.getElementById("cancelTradeBtn").addEventListener("click", closeTradeModal);
      document.getElementById("tradeBackdrop").addEventListener("click", (e)=>{
        if (e.target.id === "tradeBackdrop") closeTradeModal();
      });
      document.getElementById("saveTradeBtn").addEventListener("click", saveTrade);

      // refresh buttons
      document.getElementById("refreshBtn1").addEventListener("click", fullRefresh);
      document.getElementById("refreshBtn2").addEventListener("click", fullRefresh);

      // journal
      loadJournal();
      document.getElementById("journalSaveBtn").addEventListener("click", saveJournal);

      // auth
      const u = await requireAuth();
      if (!u) return;

      // route default
      if (!location.hash) location.hash = "focus";
      renderRoute();

      await fullRefresh();
    }

    init();
  </script>
</body>
</html>
