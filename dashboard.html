<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sessionly dashboard</title>
  <meta name="description" content="Sessionly dashboard" />
  <style>
    :root{
      --bg:#070a12;
      --panel:#0b1020;
      --card:rgba(15,22,42,.78);
      --card2:rgba(12,18,36,.72);
      --stroke:rgba(120,140,190,.20);
      --stroke2:rgba(120,140,190,.28);
      --text:#eaf0ff;
      --muted:#aab6d2;

      --accent:#7c3aed;        /* purple */
      --accent2:#22c55e;       /* green */
      --danger:#ef4444;        /* red */
      --warn:#f59e0b;

      --sidebarText:#e8eef7;
      --sidebarMuted:#a8b3c5;

      --shadow: 0 20px 80px rgba(0,0,0,.55);
      --shadow2: 0 12px 40px rgba(0,0,0,.38);

      --radius:18px;
      --radius2:22px;
    }

    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:#eef2ff;
      --card:rgba(255,255,255,.82);
      --card2:rgba(255,255,255,.74);
      --stroke:rgba(40,55,120,.16);
      --stroke2:rgba(40,55,120,.22);
      --text:#0b1222;
      --muted:#44506a;

      --accent:#5b21b6;
      --accent2:#16a34a;

      --sidebarText:#2f1f7a;
      --sidebarMuted:#4d5b72;

      --shadow: 0 18px 70px rgba(25,35,80,.12);
      --shadow2: 0 10px 30px rgba(25,35,80,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(1100px 640px at 18% -6%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 62%),
        radial-gradient(900px 540px at 84% 8%, color-mix(in srgb, var(--accent2) 12%, transparent), transparent 66%),
        linear-gradient(180deg, var(--bg) 0%, color-mix(in srgb, var(--bg) 92%, #000 8%) 100%);
    }

    [data-theme="light"] body{
      background:
        radial-gradient(900px 500px at 16% 0%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 62%),
        radial-gradient(800px 420px at 86% 8%, color-mix(in srgb, var(--accent2) 7%, transparent), transparent 64%),
        linear-gradient(180deg, #f7f8ff 0%, #f1f4ff 100%);
    }

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
    }

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr;}
      .sidebar{position:sticky; top:0; z-index:50}
    }

    /* sidebar */
    .sidebar{
      padding:22px 18px;
      border-right:1px solid var(--stroke);
      background:
        linear-gradient(180deg, rgba(8,10,16,.72), rgba(8,10,16,.42));
      backdrop-filter: blur(14px);
    }
    [data-theme="light"] .sidebar{
      background:
        linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.52));
    }

    .sidebar,.sidebar *{color:var(--sidebarText)}
    .signed,.slogan{color:var(--sidebarMuted)}
    .logoRow{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px; margin-bottom:10px;}
    .logoDot{
      width:12px; height:12px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, color-mix(in srgb, var(--accent) 85%, #000 15%) 40%, color-mix(in srgb, var(--accent) 90%, #000 10%) 100%);
      box-shadow: 0 0 0 7px color-mix(in srgb, var(--accent) 18%, transparent);
    }
    .signed{font-size:13px; opacity:.95; margin:6px 0 14px 0;}
    .navGroup{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .navBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid color-mix(in srgb, var(--stroke) 100%, transparent);
      background: rgba(255,255,255,0);
      cursor:pointer;
      font-weight:850;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
    }
    .navBtn:hover{
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--accent) 8%, transparent);
      border-color: color-mix(in srgb, var(--accent) 26%, var(--stroke) 74%);
    }
    .navBtn.active{
      background: color-mix(in srgb, var(--accent) 14%, transparent);
      border-color: color-mix(in srgb, var(--accent) 38%, var(--stroke) 62%);
      box-shadow: 0 10px 30px color-mix(in srgb, var(--accent) 14%, transparent);
    }
    .tag{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--stroke) 100%, transparent);
      background: color-mix(in srgb, var(--panel) 55%, transparent);
      opacity:.95;
    }
    .sidebarActions{
      margin-top:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ghostBtn{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 28%, transparent);
      font-weight:900;
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
    }
    .ghostBtn:hover{
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent) 26%, var(--stroke) 74%);
    }
    .slogan{
      margin-top:14px;
      font-size:13px;
      line-height:1.35;
      opacity:.9;
    }

    /* main */
    .main{
      padding:28px 26px 44px 26px;
    }
    .wrap{
      max-width: 1140px;
      margin:0 auto;
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(800px 320px at 18% 0%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 60%),
        radial-gradient(700px 320px at 84% 6%, color-mix(in srgb, var(--accent2) 12%, transparent), transparent 62%);
      opacity:.65;
      pointer-events:none;
      filter: blur(0px);
    }

    .panelInner{position:relative; padding:22px;}
    .panelHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }
    .title{
      font-size:34px;
      font-weight:950;
      letter-spacing:-.6px;
      margin:0;
      line-height:1.05;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-weight:650;
      font-size:14px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 34%, transparent);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .badgeDot{
      width:8px; height:8px; border-radius:999px;
      background: var(--accent2);
      box-shadow: 0 0 0 6px color-mix(in srgb, var(--accent2) 16%, transparent);
    }

    .ctaRow{
      margin-top:12px;
      display:flex;
      gap:12px;
      align-items:center;
    }

    .cta{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px 14px;
      border-radius: 16px;
      border:1px solid color-mix(in srgb, var(--accent) 34%, transparent);
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 85%, #000 15%), color-mix(in srgb, var(--accent) 55%, #000 45%));
      color:#fff;
      font-weight:950;
      cursor:pointer;
      transition: transform .08s ease, filter .18s ease;
      box-shadow: 0 14px 40px color-mix(in srgb, var(--accent) 20%, transparent);
    }
    .cta:hover{transform: translateY(-1px); filter: brightness(1.04);}
    .cta:active{transform: translateY(0px);}

    .gridStats{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 1040px){ .gridStats{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 560px){ .gridStats{grid-template-columns: 1fr;} }

    .statCard{
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 34%, transparent);
      border-radius: var(--radius);
      padding:14px 14px;
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .statCard::after{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(260px 120px at 10% 0%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 70%);
      opacity:.65;
      pointer-events:none;
    }
    .statLabel{position:relative; font-size:12px; font-weight:950; letter-spacing:.4px; opacity:.85; text-transform:uppercase;}
    .statValue{position:relative; margin-top:8px; font-size:28px; font-weight:980; letter-spacing:-.6px;}
    .statHint{position:relative; margin-top:4px; font-size:12px; color:var(--muted); font-weight:650;}

    .gridMain{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.35fr .85fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .gridMain{grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 34%, transparent);
      border-radius: var(--radius2);
      padding:16px;
      box-shadow: var(--shadow2);
    }
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .cardTitle{
      font-size:18px;
      font-weight:950;
      letter-spacing:-.2px;
      margin:0;
    }
    .pill{
      font-size:12px;
      font-weight:950;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 34%, transparent);
      padding:6px 10px;
      border-radius:999px;
      opacity:.95;
      white-space:nowrap;
    }
    .pill.ok{border-color: color-mix(in srgb, var(--accent2) 36%, var(--stroke) 64%); }
    .pill.warn{border-color: color-mix(in srgb, var(--warn) 42%, var(--stroke) 58%); }
    .pill.live{border-color: color-mix(in srgb, var(--accent) 42%, var(--stroke) 58%); }

    /* table */
    table{width:100%; border-collapse:collapse;}
    th,td{padding:10px 10px; border-bottom:1px solid var(--stroke); text-align:left; font-size:14px;}
    th{font-size:12px; text-transform:uppercase; letter-spacing:.4px; opacity:.75;}
    .emptyRow{
      color:var(--muted);
      font-weight:650;
      padding:14px 10px;
    }

    /* coach card */
    .coachText{
      color:var(--text);
      font-weight:800;
      line-height:1.45;
      margin:6px 0 12px 0;
    }
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 12px 0;}
    .chip{
      font-size:13px;
      font-weight:900;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 32%, transparent);
      padding:8px 12px;
      border-radius:999px;
      opacity:.98;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
      cursor:default;
    }
    .chip:hover{
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent) 30%, var(--stroke) 70%);
    }
    .mutedLine{color:var(--muted); font-weight:650; font-size:13px; line-height:1.35;}
    .miniBtn{
      width:100%;
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 34%, transparent);
      font-weight:950;
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
    }
    .miniBtn:hover{
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--accent2) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent2) 24%, var(--stroke) 76%);
    }

    /* analytics layout */
    .gridAnalyticsTop{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .gridAnalyticsTop{grid-template-columns: 1fr;} }

    .gridCharts{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .gridCharts{grid-template-columns: 1fr;} }

    .chartBox{
      border:1px dashed color-mix(in srgb, var(--stroke2) 100%, transparent);
      border-radius:18px;
      height:240px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    canvas{display:block; width:100%; height:100%;}
    .chartHint{
      position:absolute;
      inset:auto 12px 12px 12px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      opacity:.9;
    }

    /* modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(760px, 100%);
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(680px 220px at 10% 0%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 70%),
        radial-gradient(640px 220px at 90% 0%, color-mix(in srgb, var(--accent2) 12%, transparent), transparent 72%);
      opacity:.7;
      pointer-events:none;
    }
    .modalInner{position:relative; padding:18px;}
    .modalHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .modalTitle{margin:0; font-size:20px; font-weight:980; letter-spacing:-.2px;}
    .closeBtn{
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 34%, transparent);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
    }
    .formGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){ .formGrid{grid-template-columns: 1fr;} }
    label{
      display:block;
      font-size:12px;
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:.35px;
      opacity:.8;
      margin:0 0 6px 2px;
    }
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 34%, transparent);
      color:var(--text);
      font-weight:800;
      outline:none;
    }
    textarea{min-height:96px; resize:vertical;}

    input[type="datetime-local"]{
      border-radius:16px;
      padding:14px 14px;
    }
    input[type="datetime-local"]::-webkit-calendar-picker-indicator{
      opacity:.75;
      cursor:pointer;
      filter: drop-shadow(0 0 10px color-mix(in srgb, var(--accent) 35%, transparent));
    }

    .modalActions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .saveBtn{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid color-mix(in srgb, var(--accent2) 34%, transparent);
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent2) 85%, #000 15%), color-mix(in srgb, var(--accent2) 58%, #000 42%));
      color:#fff;
      font-weight:980;
      cursor:pointer;
    }
    .msg{
      margin-top:10px;
      min-height:20px;
      font-size:13px;
      color:var(--muted);
      font-weight:750;
    }

    /* pages */
    .page{display:none;}
    .page.active{display:block;}
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logoRow"><span class="logoDot"></span><span>Sessionly</span></div>
      <div class="signed">signed in as <span id="userEmail">...</span></div>

      <div class="navGroup">
        <button class="navBtn" data-route="focus">
          <span>focus</span><span class="tag">daily</span>
        </button>
        <button class="navBtn" data-route="analytics">
          <span>analytics</span><span class="tag">charts</span>
        </button>
        <button class="navBtn" data-route="trades">
          <span>trades</span><span class="tag">table</span>
        </button>
        <button class="navBtn" data-route="journal">
          <span>journal</span><span class="tag">notes</span>
        </button>
      </div>

      <div class="sidebarActions">
        <button class="ghostBtn" id="toggleThemeBtn">toggle theme</button>
        <button class="ghostBtn" id="logoutBtn">log out</button>
      </div>

      <div class="slogan">calm by default, deep when you want it</div>
    </aside>

    <main class="main">
      <div class="wrap">

        <!-- focus page -->
        <section class="page" id="page-focus">
          <div class="panel">
            <div class="panelInner">
              <div class="panelHeader">
                <div>
                  <h1 class="title">focus</h1>
                  <div class="subtitle">your daily view, clean and calm</div>
                </div>
                <div class="badge"><span class="badgeDot"></span><span id="focusStatus">ready</span></div>
              </div>

              <div class="ctaRow">
                <button class="cta" id="addTradeBtn">+ add trade</button>
              </div>

              <div class="gridStats">
                <div class="statCard">
                  <div class="statLabel">recent trades loaded</div>
                  <div class="statValue" id="s_loaded">—</div>
                  <div class="statHint" id="s_loaded_hint">last 8 trades</div>
                </div>
                <div class="statCard">
                  <div class="statLabel">win rate</div>
                  <div class="statValue" id="s_winrate">—</div>
                  <div class="statHint" id="s_winrate_hint">wins / last 8 trades</div>
                </div>
                <div class="statCard">
                  <div class="statLabel">total r</div>
                  <div class="statValue" id="s_totalr">—</div>
                  <div class="statHint">sum r multiple</div>
                </div>
                <div class="statCard">
                  <div class="statLabel">avg rr</div>
                  <div class="statValue" id="s_avgrr">—</div>
                  <div class="statHint">average rr</div>
                </div>
              </div>

              <div class="gridMain">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="cardTitle">recent trades</h3>
                    <span class="pill ok" id="recentPill">ready</span>
                  </div>

                  <div style="overflow:auto;">
                    <table>
                      <thead>
                        <tr>
                          <th>date</th>
                          <th>symbol</th>
                          <th>dir</th>
                          <th>rr</th>
                          <th>r</th>
                        </tr>
                      </thead>
                      <tbody id="recentBody">
                        <tr><td class="emptyRow" colspan="5">loading…</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="cardTitle">today’s focus</h3>
                    <span class="pill live">coach</span>
                  </div>
                  <div class="coachText">log the next trade immediately after closing it, and write one sentence on why you entered</div>
                  <div class="chips">
                    <div class="chip">session ny</div>
                    <div class="chip">rule max 3 trades</div>
                    <div class="chip">goal no revenge</div>
                  </div>
                  <div class="mutedLine">next we’ll generate this from your real patterns and mistakes, for now it’s a placeholder</div>
                  <button class="miniBtn" id="refreshBtn">refresh stats</button>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- analytics page -->
        <section class="page" id="page-analytics">
          <div class="panel">
            <div class="panelInner">
              <div class="panelHeader">
                <div>
                  <h1 class="title">analytics</h1>
                  <div class="subtitle">deep data lives here, focus stays clean</div>
                </div>
                <div class="badge"><span class="badgeDot"></span><span>live</span></div>
              </div>

              <div class="gridAnalyticsTop">
                <div class="statCard">
                  <div class="statLabel">profit factor</div>
                  <div class="statValue" id="a_pf">—</div>
                  <div class="statHint" id="a_pf_hint">from r multiple</div>
                </div>
                <div class="statCard">
                  <div class="statLabel">avg win vs avg loss</div>
                  <div class="statValue" id="a_awal">—</div>
                  <div class="statHint">avg win r vs avg loss r</div>
                </div>
                <div class="statCard">
                  <div class="statLabel">best hour</div>
                  <div class="statValue" id="a_besthour">—</div>
                  <div class="statHint" id="a_besthour_hint">avg r</div>
                </div>
              </div>

              <div class="gridCharts">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="cardTitle">hourly performance</h3>
                    <span class="pill">sessionly</span>
                  </div>
                  <div class="chartBox">
                    <canvas id="hourlyCanvas"></canvas>
                    <div class="chartHint">bars = total r per hour</div>
                  </div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="cardTitle">equity curve</h3>
                    <span class="pill">trend</span>
                  </div>
                  <div class="chartBox">
                    <canvas id="equityCanvas"></canvas>
                    <div class="chartHint">line = cumulative r over time</div>
                  </div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="cardTitle">win vs loss distribution</h3>
                    <span class="pill">edge</span>
                  </div>
                  <div class="chartBox">
                    <canvas id="donutCanvas"></canvas>
                    <div class="chartHint">donut = win loss breakeven</div>
                  </div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="cardTitle">pnl by day</h3>
                    <span class="pill">calendar</span>
                  </div>
                  <div class="chartBox">
                    <canvas id="calendarCanvas"></canvas>
                    <div class="chartHint">heat = total r per day</div>
                  </div>
                </div>
              </div>

              <div style="margin-top:10px;color:var(--muted);font-weight:700;font-size:13px;">
                log trades and the charts will update instantly
              </div>

            </div>
          </div>
        </section>

        <!-- trades page -->
        <section class="page" id="page-trades">
          <div class="panel">
            <div class="panelInner">
              <div class="panelHeader">
                <div>
                  <h1 class="title">trades</h1>
                  <div class="subtitle">your full list, searchable next</div>
                </div>
                <div class="badge"><span class="badgeDot"></span><span id="tradesCountBadge">0</span></div>
              </div>

              <div class="card">
                <div class="cardHead">
                  <h3 class="cardTitle">all trades</h3>
                  <span class="pill">table</span>
                </div>

                <div style="overflow:auto;">
                  <table>
                    <thead>
                      <tr>
                        <th>date</th>
                        <th>symbol</th>
                        <th>dir</th>
                        <th>rr</th>
                        <th>r</th>
                        <th>session</th>
                        <th>strategy</th>
                      </tr>
                    </thead>
                    <tbody id="allTradesBody">
                      <tr><td class="emptyRow" colspan="7">loading…</td></tr>
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
        </section>

        <!-- journal page -->
        <section class="page" id="page-journal">
          <div class="panel">
            <div class="panelInner">
              <div class="panelHeader">
                <div>
                  <h1 class="title">journal</h1>
                  <div class="subtitle">notes and patterns, coming next</div>
                </div>
                <div class="badge"><span class="badgeDot"></span><span>soon</span></div>
              </div>

              <div class="card">
                <div class="cardHead">
                  <h3 class="cardTitle">quick note</h3>
                  <span class="pill warn">placeholder</span>
                </div>
                <div class="mutedLine">
                  next we’ll save daily notes and auto surface your repeating mistakes and best setups
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- modal -->
  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-label="add trade">
      <div class="modalInner">
        <div class="modalHead">
          <div>
            <h3 class="modalTitle">add trade</h3>
            <div class="subtitle" style="margin-top:4px;">fast logging, clean data</div>
          </div>
          <button class="closeBtn" id="closeModalBtn">close</button>
        </div>

        <div class="formGrid">
          <div>
            <label>date and time</label>
            <input id="t_date" type="datetime-local" />
          </div>

          <div>
            <label>symbol</label>
            <input id="t_symbol" placeholder="xauusd / nasdaq / btc" />
          </div>

          <div>
            <label>direction</label>
            <select id="t_direction">
              <option value="long">long</option>
              <option value="short">short</option>
            </select>
          </div>

          <div>
            <label>result</label>
            <select id="t_result">
              <option value="win">win</option>
              <option value="loss">loss</option>
              <option value="be">breakeven</option>
            </select>
          </div>

          <div>
            <label>rr (optional)</label>
            <input id="t_rr" type="number" step="0.01" placeholder="1.0" />
          </div>

          <div>
            <label>r multiple (enter absolute)</label>
            <input id="t_r" type="number" step="0.01" placeholder="1.3" />
          </div>

          <div>
            <label>session (optional)</label>
            <select id="t_session">
              <option value="">—</option>
              <option value="asia">asia</option>
              <option value="london">london</option>
              <option value="ny">ny</option>
              <option value="overlap">overlap</option>
            </select>
          </div>

          <div>
            <label>strategy (optional)</label>
            <input id="t_strategy" placeholder="fvg / breakout / mean reversion" />
          </div>

          <div style="grid-column: 1 / -1;">
            <label>mistakes (optional, comma separated)</label>
            <input id="t_mistakes" placeholder="late entry, revenge, no stop" />
          </div>

          <div style="grid-column: 1 / -1;">
            <label>notes (optional)</label>
            <textarea id="t_notes" placeholder="why you entered, what you’ll fix next"></textarea>
          </div>
        </div>

        <div class="modalActions">
          <button class="ghostBtn" id="clearBtn" style="width:auto;">clear</button>
          <button class="saveBtn" id="saveBtn">save trade</button>
        </div>

        <div class="msg" id="modalMsg"></div>
      </div>
    </div>
  </div>

  <!-- supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = "https://oucikdsngvdhimquclcz.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_gMETcAB_TRLGd8hqx48KRA_yXxE7U6v";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === STATE ===
    let user = null;
    let trades = []; // full list for analytics + tables

    // === THEME ===
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("sessionly_theme", theme);
    }
    function initTheme(){
      const saved = localStorage.getItem("sessionly_theme");
      applyTheme(saved || "dark");
    }

    // === ROUTING ===
    const routes = ["focus","analytics","trades","journal"];

    function setActiveRoute(route){
      if (!routes.includes(route)) route = "focus";

      // show/hide pages
      routes.forEach(r=>{
        const page = document.getElementById(`page-${r}`);
        if (page) page.classList.toggle("active", r === route);
      });

      // sidebar active
      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.route === route);
      });

      // update hash without jump
      if (location.hash.replace("#","") !== route){
        history.replaceState(null, "", `#${route}`);
      }

      // repaint charts when analytics visible
      if (route === "analytics"){
        renderAnalytics();
      }
      if (route === "trades"){
        renderTradesTable();
      }
    }

    function initRouting(){
      const fromHash = location.hash.replace("#","").trim();
      setActiveRoute(fromHash || "focus");

      window.addEventListener("hashchange", ()=>{
        const r = location.hash.replace("#","").trim();
        setActiveRoute(r || "focus");
      });

      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          setActiveRoute(btn.dataset.route);
        });
      });
    }

    // === AUTH GUARD ===
    async function requireAuth(){
      const { data, error } = await sb.auth.getSession();
      if (error) {
        console.error(error);
      }
      const session = data?.session;
      if (!session){
        // redirect to login page you already have
        window.location.href = "login.html";
        return false;
      }
      user = session.user;
      document.getElementById("userEmail").textContent = user.email || "signed in";
      return true;
    }

    // === MODAL ===
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalMsg = document.getElementById("modalMsg");

    function openTradeModal(){
      modalMsg.textContent = "";

      const now = new Date();
      const iso = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);

      const dateEl = document.getElementById("t_date");
      dateEl.value = iso;
      dateEl.max = iso; // prevents future dates in picker

      document.getElementById("t_symbol").value = "";
      document.getElementById("t_direction").value = "long";
      document.getElementById("t_result").value = "win";
      document.getElementById("t_rr").value = "";
      document.getElementById("t_r").value = "";
      document.getElementById("t_session").value = "";
      document.getElementById("t_strategy").value = "";
      document.getElementById("t_mistakes").value = "";
      document.getElementById("t_notes").value = "";

      modalBackdrop.style.display = "flex";
    }

    function closeTradeModal(){
      modalBackdrop.style.display = "none";
    }

    // === DATA LOAD ===
    async function loadTrades(){
      if (!user) return;

      // load recent 500 trades (enough for charts right now)
      const { data, error } = await sb
        .from("trades")
        .select("id, trade_date, symbol, direction, rr, r_multiple, notes, session, strategy, mistakes, created_at")
        .eq("user_id", user.id)
        .order("trade_date", { ascending: false })
        .limit(500);

      if (error){
        console.error(error);
        document.getElementById("recentPill").classList.remove("ok");
        document.getElementById("recentPill").classList.add("warn");
        document.getElementById("recentPill").textContent = "error";
        document.getElementById("recentBody").innerHTML =
          `<tr><td class="emptyRow" colspan="5">error loading trades: ${escapeHtml(error.message)}</td></tr>`;
        return;
      }

      trades = (data || []).map(normalizeTrade);
      renderFocus();
      renderAnalytics();
      renderTradesTable();
    }

    function normalizeTrade(t){
      const dt = t.trade_date ? new Date(t.trade_date) : null;
      return {
        id: t.id,
        trade_date: t.trade_date,
        dt,
        symbol: t.symbol || "",
        direction: t.direction || "",
        rr: (t.rr === null || t.rr === undefined) ? null : Number(t.rr),
        r_multiple: (t.r_multiple === null || t.r_multiple === undefined) ? null : Number(t.r_multiple),
        notes: t.notes || "",
        session: t.session || "",
        strategy: t.strategy || "",
        mistakes: Array.isArray(t.mistakes) ? t.mistakes : (t.mistakes ? [String(t.mistakes)] : []),
      };
    }

    // === RENDER: FOCUS ===
    function renderFocus(){
      const recent = trades.slice(0, 8);

      // stats
      document.getElementById("s_loaded").textContent = String(recent.length);
      const wins = recent.filter(x => (x.r_multiple ?? 0) > 0).length;
      const decided = recent.filter(x => (x.r_multiple ?? 0) !== 0 && x.r_multiple !== null).length;
      const winRate = decided ? (wins / decided) : 0;

      document.getElementById("s_winrate").textContent = decided ? `${(winRate*100).toFixed(1)}%` : "—";

      const totalR = recent.reduce((a,x)=> a + (Number.isFinite(x.r_multiple) ? x.r_multiple : 0), 0);
      document.getElementById("s_totalr").textContent = formatNumber(totalR);

      const rrVals = recent.map(x => x.rr).filter(v => Number.isFinite(v));
      const avgRR = rrVals.length ? rrVals.reduce((a,b)=>a+b,0)/rrVals.length : null;
      document.getElementById("s_avgrr").textContent = avgRR === null ? "—" : formatNumber(avgRR);

      // table
      const body = document.getElementById("recentBody");
      if (!recent.length){
        body.innerHTML = `<tr><td class="emptyRow" colspan="5">no trades yet, add your first one</td></tr>`;
      } else {
        body.innerHTML = recent.map(row=>{
          const date = row.dt ? fmtDate(row.dt) : "—";
          const sym = escapeHtml(row.symbol || "—");
          const dir = escapeHtml(row.direction || "—");
          const rr = row.rr === null ? "—" : formatNumber(row.rr);
          const r = row.r_multiple === null ? "—" : formatNumber(row.r_multiple);
          return `
            <tr>
              <td>${date}</td>
              <td>${sym}</td>
              <td>${dir}</td>
              <td>${rr}</td>
              <td>${r}</td>
            </tr>
          `;
        }).join("");
      }

      // pills
      document.getElementById("recentPill").textContent = "ready";
      document.getElementById("focusStatus").textContent = "ready";
    }

    // === RENDER: TRADES TABLE ===
    function renderTradesTable(){
      const body = document.getElementById("allTradesBody");
      document.getElementById("tradesCountBadge").textContent = String(trades.length);

      if (!trades.length){
        body.innerHTML = `<tr><td class="emptyRow" colspan="7">no trades yet</td></tr>`;
        return;
      }

      body.innerHTML = trades.map(row=>{
        const date = row.dt ? fmtDateTime(row.dt) : "—";
        const sym = escapeHtml(row.symbol || "—");
        const dir = escapeHtml(row.direction || "—");
        const rr = row.rr === null ? "—" : formatNumber(row.rr);
        const r = row.r_multiple === null ? "—" : formatNumber(row.r_multiple);
        const session = escapeHtml(row.session || "—");
        const strategy = escapeHtml(row.strategy || "—");

        return `
          <tr>
            <td>${date}</td>
            <td>${sym}</td>
            <td>${dir}</td>
            <td>${rr}</td>
            <td>${r}</td>
            <td>${session}</td>
            <td>${strategy}</td>
          </tr>
        `;
      }).join("");
    }

    // === RENDER: ANALYTICS ===
    function renderAnalytics(){
      // profit factor from r_multiple
      const rVals = trades
        .map(t => t.r_multiple)
        .filter(v => Number.isFinite(v));

      const wins = rVals.filter(v => v > 0);
      const losses = rVals.filter(v => v < 0);
      const bes = rVals.filter(v => v === 0);

      const sumWins = wins.reduce((a,b)=>a+b,0);
      const sumLossAbs = Math.abs(losses.reduce((a,b)=>a+b,0));
      const pf = (sumLossAbs > 0) ? (sumWins / sumLossAbs) : (wins.length ? Infinity : null);

      document.getElementById("a_pf").textContent = pf === null ? "—" : (pf === Infinity ? "∞" : formatNumber(pf));
      document.getElementById("a_pf_hint").textContent = `from ${rVals.length} trades`;

      const avgWin = wins.length ? (sumWins / wins.length) : null;
      const avgLoss = losses.length ? (Math.abs(losses.reduce((a,b)=>a+b,0)) / losses.length) : null;
      document.getElementById("a_awal").textContent =
        (avgWin === null || avgLoss === null) ? "—" : `${formatNumber(avgWin)} / ${formatNumber(avgLoss)}`;

      // best hour by avg r
      const byHour = new Map(); // hour -> {sum,count}
      trades.forEach(t=>{
        if (!t.dt || !Number.isFinite(t.r_multiple)) return;
        const h = t.dt.getHours();
        const cur = byHour.get(h) || {sum:0,count:0};
        cur.sum += t.r_multiple;
        cur.count += 1;
        byHour.set(h, cur);
      });

      let bestHour = null;
      let bestAvg = -Infinity;
      for (const [h, v] of byHour.entries()){
        const avg = v.sum / Math.max(1, v.count);
        if (avg > bestAvg){
          bestAvg = avg;
          bestHour = h;
        }
      }
      document.getElementById("a_besthour").textContent = bestHour === null ? "—" : `${String(bestHour).padStart(2,"0")}:00`;
      document.getElementById("a_besthour_hint").textContent = bestHour === null ? "avg r" : `avg r ${formatNumber(bestAvg)}`;

      // charts
      drawHourlyCanvas(byHour);
      drawEquityCanvas();
      drawDonutCanvas(wins.length, losses.length, bes.length);
      drawCalendarCanvas();
    }

    // === CHART HELPERS (no external libs) ===
    function prepCanvas(id){
      const c = document.getElementById(id);
      if (!c) return null;
      const rect = c.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      c.width = Math.max(1, Math.floor(rect.width * dpr));
      c.height = Math.max(1, Math.floor(rect.height * dpr));
      const ctx = c.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {c, ctx, w: rect.width, h: rect.height};
    }

    function colorVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function drawGlassGrid(ctx, w, h){
      ctx.save();
      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = colorMix(colorVar("--stroke"), "transparent", 0.0);
      ctx.lineWidth = 1;

      const step = 28;
      for (let x=0; x<=w; x+=step){
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
      }
      for (let y=0; y<=h; y+=step){
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawHourlyCanvas(byHour){
      const pack = prepCanvas("hourlyCanvas");
      if (!pack) return;
      const {ctx,w,h} = pack;

      ctx.clearRect(0,0,w,h);
      drawGlassGrid(ctx,w,h);

      // bars (sum r per hour)
      const arr = [];
      for (let i=0;i<24;i++){
        const v = byHour.get(i);
        arr.push({h:i, val: v ? v.sum : 0});
      }

      const maxAbs = Math.max(1, ...arr.map(x => Math.abs(x.val)));
      const pad = 18;
      const baseY = h/2;
      const innerW = w - pad*2;
      const barW = innerW / 24;

      // axis line
      ctx.save();
      ctx.strokeStyle = colorVar("--stroke2");
      ctx.globalAlpha = 0.9;
      ctx.beginPath();
      ctx.moveTo(pad, baseY);
      ctx.lineTo(w-pad, baseY);
      ctx.stroke();
      ctx.restore();

      arr.forEach((b, i)=>{
        const x = pad + i*barW + barW*0.22;
        const bw = barW*0.56;
        const norm = b.val / maxAbs;
        const barH = norm * (h*0.34);

        const y = baseY - Math.max(0, barH);
        const hh = Math.abs(barH);

        const isPos = b.val >= 0;
        const col = isPos ? colorVar("--accent") : colorVar("--danger");

        // bar
        roundRect(ctx, x, y, bw, hh, 8);
        const grad = ctx.createLinearGradient(x,y,x,y+hh);
        grad.addColorStop(0, colorMix(col, "#ffffff", 0.12));
        grad.addColorStop(1, colorMix(col, "#000000", 0.22));
        ctx.fillStyle = grad;
        ctx.globalAlpha = 0.92;
        ctx.fill();

        // glow
        ctx.globalAlpha = 0.20;
        ctx.shadowColor = col;
        ctx.shadowBlur = 18;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
      });
    }

    function drawEquityCanvas(){
      const pack = prepCanvas("equityCanvas");
      if (!pack) return;
      const {ctx,w,h} = pack;

      ctx.clearRect(0,0,w,h);
      drawGlassGrid(ctx,w,h);

      // sort by date asc
      const sorted = [...trades]
        .filter(t => t.dt && Number.isFinite(t.r_multiple))
        .sort((a,b)=> a.dt - b.dt);

      const pad = 18;
      const innerW = w - pad*2;
      const innerH = h - pad*2;

      if (sorted.length < 2){
        ctx.save();
        ctx.fillStyle = colorVar("--muted");
        ctx.globalAlpha = 0.9;
        ctx.font = "700 13px ui-sans-serif, system-ui";
        ctx.fillText("equity curve will appear after 2+ trades", pad, h/2);
        ctx.restore();
        return;
      }

      let cum = 0;
      const pts = sorted.map(t=>{
        cum += t.r_multiple;
        return {x:0, y:cum};
      });

      const minY = Math.min(...pts.map(p=>p.y));
      const maxY = Math.max(...pts.map(p=>p.y));
      const span = Math.max(1e-9, maxY - minY);

      pts.forEach((p,i)=>{
        p.x = pad + (i/(pts.length-1))*innerW;
        p.y = pad + (1 - ((p.y - minY)/span))*innerH;
      });

      // axis baseline subtle
      ctx.save();
      ctx.strokeStyle = colorVar("--stroke2");
      ctx.globalAlpha = 0.85;
      ctx.beginPath();
      ctx.moveTo(pad, pad + innerH);
      ctx.lineTo(pad + innerW, pad + innerH);
      ctx.stroke();
      ctx.restore();

      // gradient fill under line
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for (let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
      ctx.lineTo(pts[pts.length-1].x, pad + innerH);
      ctx.lineTo(pts[0].x, pad + innerH);
      ctx.closePath();

      const fillGrad = ctx.createLinearGradient(0,pad,0,pad+innerH);
      fillGrad.addColorStop(0, colorMix(colorVar("--accent2"), "transparent", 0.70));
      fillGrad.addColorStop(1, "transparent");
      ctx.fillStyle = fillGrad;
      ctx.globalAlpha = 0.55;
      ctx.fill();
      ctx.restore();

      // line
      ctx.save();
      ctx.lineWidth = 3;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      const lineGrad = ctx.createLinearGradient(pad,0,pad+innerW,0);
      lineGrad.addColorStop(0, colorVar("--accent"));
      lineGrad.addColorStop(1, colorVar("--accent2"));
      ctx.strokeStyle = lineGrad;
      ctx.globalAlpha = 0.95;

      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for (let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
      ctx.stroke();

      // glow
      ctx.shadowColor = colorVar("--accent");
      ctx.shadowBlur = 16;
      ctx.stroke();
      ctx.restore();

      // last point
      const last = pts[pts.length-1];
      ctx.save();
      ctx.fillStyle = colorVar("--accent2");
      ctx.globalAlpha = 0.95;
      ctx.beginPath();
      ctx.arc(last.x, last.y, 4.5, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    function drawDonutCanvas(winCount, lossCount, beCount){
      const pack = prepCanvas("donutCanvas");
      if (!pack) return;
      const {ctx,w,h} = pack;

      ctx.clearRect(0,0,w,h);
      drawGlassGrid(ctx,w,h);

      const total = Math.max(1, winCount + lossCount + beCount);
      const cx = w/2, cy = h/2;
      const r = Math.min(w,h)*0.30;
      const thick = Math.max(10, r*0.28);

      const arcs = [
        {label:"win", val: winCount, color: colorVar("--accent2")},
        {label:"loss", val: lossCount, color: colorVar("--danger")},
        {label:"be", val: beCount, color: colorVar("--accent")}
      ];

      // base ring
      ctx.save();
      ctx.strokeStyle = colorVar("--stroke2");
      ctx.globalAlpha = 0.9;
      ctx.lineWidth = thick;
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();

      let start = -Math.PI/2;
      arcs.forEach(seg=>{
        const ang = (seg.val / total) * Math.PI*2;
        if (ang <= 0) return;

        ctx.save();
        ctx.lineWidth = thick;
        ctx.lineCap = "round";
        ctx.strokeStyle = seg.color;
        ctx.globalAlpha = 0.92;
        ctx.beginPath();
        ctx.arc(cx, cy, r, start, start + ang);
        ctx.stroke();

        // glow
        ctx.shadowColor = seg.color;
        ctx.shadowBlur = 14;
        ctx.stroke();

        ctx.restore();
        start += ang;
      });

      // center text
      ctx.save();
      ctx.fillStyle = colorVar("--text");
      ctx.globalAlpha = 0.92;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "980 22px ui-sans-serif, system-ui";
      ctx.fillText(`${winCount}/${total}`, cx, cy - 8);
      ctx.fillStyle = colorVar("--muted");
      ctx.font = "800 12px ui-sans-serif, system-ui";
      ctx.fillText("wins / trades", cx, cy + 14);
      ctx.restore();
    }

    function drawCalendarCanvas(){
      const pack = prepCanvas("calendarCanvas");
      if (!pack) return;
      const {ctx,w,h} = pack;

      ctx.clearRect(0,0,w,h);
      drawGlassGrid(ctx,w,h);

      // build totals per day (YYYY-MM-DD) from r_multiple
      const map = new Map();
      trades.forEach(t=>{
        if (!t.dt || !Number.isFinite(t.r_multiple)) return;
        const key = `${t.dt.getFullYear()}-${String(t.dt.getMonth()+1).padStart(2,"0")}-${String(t.dt.getDate()).padStart(2,"0")}`;
        map.set(key, (map.get(key)||0) + t.r_multiple);
      });

      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const first = new Date(year, month, 1);
      const last = new Date(year, month+1, 0);

      const pad = 16;
      const cols = 7;
      const rows = 6;

      const cellGap = 8;
      const cellW = (w - pad*2 - cellGap*(cols-1)) / cols;
      const cellH = (h - pad*2 - cellGap*(rows-1)) / rows;

      // max abs for heat scaling
      let maxAbs = 1;
      for (let d=1; d<=last.getDate(); d++){
        const dt = new Date(year, month, d);
        const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
        const val = map.get(key) || 0;
        maxAbs = Math.max(maxAbs, Math.abs(val));
      }

      // day of week offset (0 sun)
      const offset = first.getDay();

      for (let i=0;i<rows*cols;i++){
        const r = Math.floor(i/cols);
        const c = i%cols;
        const x = pad + c*(cellW+cellGap);
        const y = pad + r*(cellH+cellGap);

        const dayNum = i - offset + 1;
        const inMonth = dayNum >= 1 && dayNum <= last.getDate();

        // cell bg
        const base = colorMix(colorVar("--panel"), "transparent", 0.35);
        ctx.save();
        roundRect(ctx, x, y, cellW, cellH, 14);
        ctx.fillStyle = base;
        ctx.globalAlpha = 0.85;
        ctx.fill();

        // stroke
        ctx.globalAlpha = 0.85;
        ctx.strokeStyle = colorVar("--stroke");
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.restore();

        if (!inMonth) continue;

        const dt = new Date(year, month, dayNum);
        const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
        const val = map.get(key) || 0;

        // heat overlay
        const strength = Math.min(1, Math.abs(val)/maxAbs);
        if (strength > 0){
          const col = val >= 0 ? colorVar("--accent2") : colorVar("--danger");
          ctx.save();
          roundRect(ctx, x, y, cellW, cellH, 14);
          ctx.fillStyle = colorMix(col, "transparent", 0.65);
          ctx.globalAlpha = 0.55 + strength*0.25;
          ctx.fill();
          ctx.restore();
        }

        // day label
        ctx.save();
        ctx.fillStyle = colorVar("--text");
        ctx.globalAlpha = 0.90;
        ctx.font = "900 12px ui-sans-serif, system-ui";
        ctx.fillText(String(dayNum), x + 10, y + 18);
        ctx.restore();

        // value
        if (val !== 0){
          ctx.save();
          ctx.fillStyle = colorVar("--text");
          ctx.globalAlpha = 0.88;
          ctx.font = "900 12px ui-sans-serif, system-ui";
          const txt = (val > 0 ? "+" : "") + formatNumber(val);
          ctx.fillText(txt, x + 10, y + cellH - 12);
          ctx.restore();
        }
      }
    }

    // === SAVE TRADE ===
    async function saveTrade(){
      modalMsg.textContent = "";
      const btn = document.getElementById("saveBtn");
      btn.disabled = true;
      btn.textContent = "saving…";

      try{
        const trade_date = document.getElementById("t_date").value;
        const symbol = document.getElementById("t_symbol").value.trim();
        const direction = document.getElementById("t_direction").value;
        const result = document.getElementById("t_result").value;

        const rrRaw = document.getElementById("t_rr").value;
        const rRaw = document.getElementById("t_r").value;

        const session = document.getElementById("t_session").value.trim();
        const strategy = document.getElementById("t_strategy").value.trim();
        const mistakesRaw = document.getElementById("t_mistakes").value.trim();
        const notes = document.getElementById("t_notes").value.trim();

        if (!trade_date){
          modalMsg.textContent = "please choose a date";
          return;
        }

        // block future dates
        const chosen = new Date(trade_date).getTime();
        const now = Date.now();
        if (chosen > now){
          modalMsg.textContent = "you can’t log a trade in the future";
          return;
        }

        if (!symbol){
          modalMsg.textContent = "please enter a symbol";
          return;
        }

        const rr = rrRaw === "" ? null : Number(rrRaw);
        if (rr !== null && !Number.isFinite(rr)){
          modalMsg.textContent = "rr must be a number";
          return;
        }

        let r_multiple = (rRaw === "" ? null : Number(rRaw));
        if (r_multiple !== null && !Number.isFinite(r_multiple)){
          modalMsg.textContent = "r multiple must be a number";
          return;
        }

        // apply result to sign (user enters absolute)
        if (r_multiple !== null && Number.isFinite(r_multiple)){
          const absR = Math.abs(r_multiple);
          if (result === "win") r_multiple = absR;
          if (result === "loss") r_multiple = -absR;
          if (result === "be") r_multiple = 0;
        }

        const mistakes = mistakesRaw
          ? mistakesRaw.split(",").map(s=>s.trim()).filter(Boolean)
          : [];

        const payload = {
          user_id: user.id,
          trade_date: new Date(trade_date).toISOString(),
          symbol,
          direction,
          rr,
          r_multiple,
          session: session || null,
          strategy: strategy || null,
          mistakes: mistakes.length ? mistakes : null,
          notes: notes || null
        };

        const { error } = await sb.from("trades").insert(payload);
        if (error){
          modalMsg.textContent = `save failed: ${error.message}`;
          return;
        }

        modalMsg.textContent = "saved";
        closeTradeModal();

        await loadTrades();
        // make sure analytics updates if user is on it
        renderAnalytics();

      } finally {
        btn.disabled = false;
        btn.textContent = "save trade";
      }
    }

    // === UI WIRING ===
    function wireUI(){
      document.getElementById("addTradeBtn").addEventListener("click", openTradeModal);
      document.getElementById("closeModalBtn").addEventListener("click", closeTradeModal);
      document.getElementById("modalBackdrop").addEventListener("click", (e)=>{
        if (e.target === modalBackdrop) closeTradeModal();
      });

      document.getElementById("saveBtn").addEventListener("click", saveTrade);

      document.getElementById("clearBtn").addEventListener("click", ()=>{
        modalMsg.textContent = "";
        document.getElementById("t_symbol").value = "";
        document.getElementById("t_rr").value = "";
        document.getElementById("t_r").value = "";
        document.getElementById("t_session").value = "";
        document.getElementById("t_strategy").value = "";
        document.getElementById("t_mistakes").value = "";
        document.getElementById("t_notes").value = "";
      });

      document.getElementById("refreshBtn").addEventListener("click", async ()=>{
        await loadTrades();
      });

      document.getElementById("toggleThemeBtn").addEventListener("click", ()=>{
        const cur = document.documentElement.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
        // rerender charts after theme change
        renderAnalytics();
      });

      document.getElementById("logoutBtn").addEventListener("click", async ()=>{
        await sb.auth.signOut();
        window.location.href = "login.html";
      });

      // rerender charts on resize
      window.addEventListener("resize", ()=>{
        if (document.getElementById("page-analytics").classList.contains("active")){
          renderAnalytics();
        }
      });
    }

    // === HELPERS ===
    function fmtDate(d){
      const opts = { day:"2-digit", month:"short", year:"numeric" };
      return d.toLocaleDateString(undefined, opts);
    }
    function fmtDateTime(d){
      const date = fmtDate(d);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${date} ${hh}:${mm}`;
    }
    function formatNumber(n){
      if (!Number.isFinite(n)) return "—";
      const abs = Math.abs(n);
      if (abs >= 100) return n.toFixed(0);
      if (abs >= 10) return n.toFixed(1);
      return n.toFixed(2);
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    // very small color mixing utility (expects hex or rgba or css color from computed vars)
    function colorMix(c1, c2, t){
      // fallback simple: return c1 if parsing fails
      const a = parseColor(c1);
      const b = parseColor(c2);
      if (!a || !b) return c1;
      const r = Math.round(a.r + (b.r - a.r) * t);
      const g = Math.round(a.g + (b.g - a.g) * t);
      const b2 = Math.round(a.b + (b.b - a.b) * t);
      const aa = (a.a + (b.a - a.a) * t);
      return `rgba(${r},${g},${b2},${aa})`;
    }

    function parseColor(c){
      c = String(c).trim();
      if (!c) return null;

      // hex
      if (c[0] === "#"){
        const hex = c.slice(1);
        if (hex.length === 3){
          const r = parseInt(hex[0]+hex[0],16);
          const g = parseInt(hex[1]+hex[1],16);
          const b = parseInt(hex[2]+hex[2],16);
          return {r,g,b,a:1};
        }
        if (hex.length === 6){
          const r = parseInt(hex.slice(0,2),16);
          const g = parseInt(hex.slice(2,4),16);
          const b = parseInt(hex.slice(4,6),16);
          return {r,g,b,a:1};
        }
      }

      // rgba/ rgb
      const m = c.match(/rgba?\(([^)]+)\)/i);
      if (m){
        const parts = m[1].split(",").map(x=>x.trim());
        const r = Number(parts[0]);
        const g = Number(parts[1]);
        const b = Number(parts[2]);
        const a = parts[3] !== undefined ? Number(parts[3]) : 1;
        if ([r,g,b,a].some(x=>Number.isNaN(x))) return null;
        return {r,g,b,a};
      }

      // try computed via canvas
      try{
        const tmp = document.createElement("canvas").getContext("2d");
        tmp.fillStyle = c;
        const v = tmp.fillStyle;
        const mm = v.match(/rgba?\(([^)]+)\)/i);
        if (mm){
          const parts = mm[1].split(",").map(x=>x.trim());
          const r = Number(parts[0]);
          const g = Number(parts[1]);
          const b = Number(parts[2]);
          const a = parts[3] !== undefined ? Number(parts[3]) : 1;
          if ([r,g,b,a].some(x=>Number.isNaN(x))) return null;
          return {r,g,b,a};
        }
      } catch(e){}

      return null;
    }

    // === INIT ===
    (async function init(){
      initTheme();
      initRouting();
      wireUI();

      const ok = await requireAuth();
      if (!ok) return;

      await loadTrades();
      setActiveRoute(location.hash.replace("#","") || "focus");
    })();
  </script>
</body>
</html>
