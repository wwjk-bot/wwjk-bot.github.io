<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sessionly • dashboard</title>
  <meta name="description" content="Sessionly dashboard" />
  <style>
    :root{
      --bg:#070A0F;
      --panel:#0b1020;
      --card: rgba(12,16,26,.62);
      --card2: rgba(12,16,26,.72);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.64);
      --muted2: rgba(255,255,255,.46);
      --green:#3CF2A6;
      --green2:#19D58B;
      --purple:#7C3AED;
      --cyan:#22D3EE;
      --danger:#ef4444;
      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --shadow2: 0 18px 70px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 16px;
      --max: 1260px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: var(--bg);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    button,input,textarea{font-family:inherit}

    .bg{
      position:fixed; inset:-2px;
      z-index:-2;
      background:
        radial-gradient(1200px 900px at 15% 12%, rgba(124,58,237,.42), transparent 62%),
        radial-gradient(1000px 800px at 85% 18%, rgba(34,211,238,.22), transparent 60%),
        radial-gradient(1100px 900px at 85% 75%, rgba(60,242,166,.22), transparent 64%),
        radial-gradient(1000px 900px at 20% 82%, rgba(60,242,166,.12), transparent 64%),
        radial-gradient(1400px 1000px at 45% 55%, rgba(255,255,255,.06), transparent 65%),
        linear-gradient(180deg, #060913 0%, #070A0F 40%, #070A0F 100%);
      filter:saturate(1.05) contrast(1.05);
    }
    .grain{
      position:fixed; inset:-2px;
      z-index:-1;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.25'/%3E%3C/svg%3E");
      opacity:.08;
      mix-blend-mode:overlay;
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding: 18px 18px 80px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 0 14px;
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(10px);
    }
    .topbar::before{
      content:"";
      position:absolute; left:-30vw; right:-30vw; top:0; bottom:0;
      background: linear-gradient(180deg, rgba(7,10,15,.78), rgba(7,10,15,.40));
      z-index:-1;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--green);
      box-shadow: 0 0 0 4px rgba(60,242,166,.12), 0 0 20px rgba(60,242,166,.35);
    }

    .pill{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,16,26,.35);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.78);
      font-size:13px;
      transition: transform .2s ease, border-color .2s ease, background .2s ease;
      cursor:pointer;
    }
    .pill:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: rgba(12,16,26,.48)}
    .pill.primary{
      border-color: rgba(60,242,166,.42);
      color: rgba(0,0,0,.86);
      background: linear-gradient(180deg, rgba(60,242,166,.98), rgba(25,213,139,.92));
      box-shadow: 0 16px 40px rgba(60,242,166,.16);
      font-weight:900;
    }
    .pill.danger{
      border-color: rgba(239,68,68,.30);
      background: rgba(239,68,68,.10);
      color: rgba(255,255,255,.90);
      font-weight:900;
    }

    .layout{
      display:grid;
      grid-template-columns: 270px 1fr;
      gap: 14px;
      align-items:start;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr;}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(700px 300px at 20% 10%, rgba(60,242,166,.10), transparent 60%),
        radial-gradient(700px 320px at 90% 15%, rgba(124,58,237,.10), transparent 62%),
        radial-gradient(700px 300px at 80% 90%, rgba(34,211,238,.08), transparent 62%);
      pointer-events:none;
      opacity:.9;
    }

    /* sidebar */
    .sidebar{
      padding: 14px;
      position:sticky;
      top: 76px;
    }
    @media (max-width: 980px){
      .sidebar{position:relative; top:auto;}
    }

    .profile{
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,14,24,.55);
      position:relative;
    }
    .profileRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .avatar{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .bubble{
      width: 32px; height: 32px; border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      color: rgba(60,242,166,.92);
      font-weight:1000;
    }
    .subText{margin-top:6px; color: rgba(255,255,255,.62); font-size: 12px; line-height:1.35}

    .navList{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .tabBtn{
      width:100%;
      text-align:left;
      border-radius: 16px;
      padding: 11px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,14,24,.50);
      color: rgba(255,255,255,.78);
      font-weight:950;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .tabBtn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.16); background: rgba(10,14,24,.62)}
    .tabBtn.active{
      border-color: rgba(60,242,166,.30);
      background: rgba(60,242,166,.10);
      color: rgba(255,255,255,.92);
    }
    .tabHint{
      font-size: 11px;
      color: rgba(255,255,255,.55);
      font-weight:900;
      text-transform: lowercase;
      white-space:nowrap;
    }

    /* main panel */
    .main{
      padding: 16px;
    }
    .mainInner{padding: 16px; position:relative}
    .h1{
      margin: 2px 0 6px 0;
      font-size: 22px;
      letter-spacing:-.3px;
      font-weight: 1000;
    }
    .p{
      margin: 0 0 14px 0;
      color: rgba(255,255,255,.62);
      font-size: 13px;
      line-height: 1.45;
      max-width: 90ch;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 12px;
      align-items:start;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .grid2{grid-template-columns:1fr;}
    }

    .panel{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,14,24,.55);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }

    /* chat */
    .chat{
      height: 520px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .chatLog{
      flex:1;
      overflow:auto;
      padding: 8px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .bubbleRow{
      display:flex;
      margin: 10px 0;
      gap:10px;
    }
    .bubbleRow.user{justify-content:flex-end}
    .msgBubble{
      max-width: 78%;
      border-radius: 16px;
      padding: 10px 11px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.84);
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bubbleRow.ai .msgBubble{
      background: rgba(60,242,166,.10);
      border-color: rgba(60,242,166,.18);
    }
    .bubbleRow.user .msgBubble{
      background: rgba(124,58,237,.12);
      border-color: rgba(124,58,237,.22);
    }

    .chatInputRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .chatInput{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(12,16,26,.38);
      color: rgba(255,255,255,.92);
      padding: 11px 12px;
      font-weight:850;
      outline:none;
    }
    .btn{
      border-radius: 14px;
      padding: 11px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      font-weight:1000;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18)}
    .btn.primary{
      border-color: rgba(60,242,166,.35);
      background: linear-gradient(180deg, rgba(60,242,166,.98), rgba(25,213,139,.92));
      color: rgba(0,0,0,.86);
      box-shadow: 0 18px 40px rgba(60,242,166,.14);
    }
    .btn.subtle{
      background: rgba(12,16,26,.38);
    }

    .kpi{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpiLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(12,16,26,.28);
    }
    .kLabel{
      font-size: 11px;
      color: rgba(255,255,255,.62);
      font-weight:950;
      text-transform: uppercase;
      letter-spacing:.35px;
    }
    .kVal{
      font-size: 12px;
      font-weight:950;
      color: rgba(255,255,255,.88);
      text-align:right;
    }

    .small{
      margin-top: 10px;
      color: rgba(255,255,255,.58);
      font-size: 12px;
      line-height:1.45;
      white-space: pre-wrap;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 11.5px;
      color: rgba(255,255,255,.80);
    }
    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .hidden{display:none !important}

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important}
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="grain"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>Sessionly</span>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <a class="pill" href="./index.html">landing</a>
        <a class="pill" href="./login.html">log in</a>
        <button class="pill danger" id="logoutBtn">log out</button>
      </div>
    </div>

    <div class="layout">
      <!-- SIDEBAR -->
      <div class="card sidebar">
        <div class="mainInner" style="padding:14px;">
          <div class="profile">
            <div class="profileRow">
              <div class="avatar">
                <div class="bubble" id="avatarBubble">S</div>
                <div>
                  <div style="font-weight:1000; letter-spacing:-.2px;" id="userEmail">loading…</div>
                  <div class="subText">signed in</div>
                </div>
              </div>
              <div class="tabHint" id="planHint">beta</div>
            </div>
          </div>

          <div class="navList">
            <button class="tabBtn" data-tab="home">
              <span>overview</span>
              <span class="tabHint">stats</span>
            </button>
            <button class="tabBtn" data-tab="trades">
              <span>trades</span>
              <span class="tabHint">log</span>
            </button>
            <button class="tabBtn" data-tab="bot">
              <span>ai coach</span>
              <span class="tabHint">new</span>
            </button>
            <button class="tabBtn" data-tab="builder">
              <span>ai bot builder</span>
              <span class="tabHint">spec</span>
            </button>
            <button class="tabBtn" data-tab="settings">
              <span>settings</span>
              <span class="tabHint">soon</span>
            </button>
          </div>

          <div class="divider"></div>
          <div class="small">
            tabs are hash based so links look like
            <span class="mono">dashboard.html#bot</span>
          </div>
        </div>
      </div>

      <!-- MAIN -->
      <div class="card main">
        <div class="mainInner">
          <!-- OVERVIEW -->
          <div id="view-home" class="view hidden">
            <div class="h1">overview</div>
            <div class="p">this is a placeholder. next we can add your real kpis, todays pnl, streaks, win rate, calendar, and a quick add trade button.</div>

            <div class="grid2">
              <div class="panel">
                <div style="font-weight:1000; margin-bottom:6px;">quick actions</div>
                <div class="small">we can wire these to real pages later</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                  <button class="btn primary" onclick="location.hash='#trades'">add trade</button>
                  <button class="btn" onclick="location.hash='#builder'">build a bot</button>
                  <button class="btn" onclick="location.hash='#bot'">ai coach</button>
                  <button class="btn subtle" onclick="alert('coming soon')">weekly report</button>
                </div>
              </div>

              <div class="panel">
                <div style="font-weight:1000; margin-bottom:8px;">status</div>
                <div class="kpi">
                  <div class="kpiLine"><div><div class="kLabel">session</div></div><div class="kVal" id="kSession">active</div></div>
                  <div class="kpiLine"><div><div class="kLabel">app version</div></div><div class="kVal">dashboard v1</div></div>
                  <div class="kpiLine"><div><div class="kLabel">route</div></div><div class="kVal" id="kRoute">home</div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- TRADES -->
          <div id="view-trades" class="view hidden">
            <div class="h1">trades</div>
            <div class="p">placeholder for your trades table + add trade form. we will build this tab after the coach and builder.</div>
            <div class="panel">
              <div style="font-weight:1000;">next build here</div>
              <div class="small">
                add trade form with validation, list trades with delete, and charts later.
              </div>
            </div>
          </div>

          <!-- AI COACH -->
          <div id="view-bot" class="view hidden">
            <div class="h1">ai coach</div>
            <div class="p">chat freely. it will remember the thread and build your bot spec on the right.</div>

            <div class="grid2">
              <div class="panel">
                <div class="chat">
                  <div class="chatLog" id="coachLog" aria-live="polite"></div>

                  <div class="chatInputRow">
                    <input class="chatInput" id="coachInput" placeholder="ask the coach…" autocomplete="off" />
                    <button class="btn primary" id="coachSendBtn">send</button>
                    <button class="btn" id="coachResetBtn">reset</button>
                  </div>

                  <div class="small" id="coachStatus" style="margin-top:8px;"></div>
                </div>
              </div>

              <div class="panel">
                <div style="font-weight:1000; margin-bottom:8px;">coach insights</div>
                <div class="kpi" id="coachKpis"></div>

                <div class="divider"></div>

                <div style="font-weight:1000; margin-bottom:6px;">missing fields</div>
                <div class="small" id="coachRules">—</div>

                <div class="divider"></div>

                <div style="font-weight:1000; margin-bottom:6px;">questions to review</div>
                <div class="small" id="coachQuestions">—</div>
              </div>
            </div>
          </div>

          <!-- BOT BUILDER -->
          <div id="view-builder" class="view hidden">
            <div class="h1">ai bot builder</div>
            <div class="p">
              this is the selling point. it chats like a real assistant, fills the spec automatically, and you can export json.
            </div>

            <div class="grid2">
              <div class="panel">
                <div class="chat">
                  <div class="chatLog" id="builderLog" aria-live="polite"></div>

                  <div class="chatInputRow">
                    <input class="chatInput" id="builderInput" placeholder="type here…" autocomplete="off" />
                    <button class="btn primary" id="builderSendBtn">send</button>
                    <button class="btn" id="builderResetBtn">reset</button>
                  </div>

                  <div class="small" id="builderStatus" style="margin-top:8px;"></div>
                </div>
              </div>

              <div class="panel">
                <div style="font-weight:1000; margin-bottom:8px;">current bot spec</div>

                <div class="kpi" id="specKpis"></div>

                <div class="divider"></div>

                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="copySpecBtn">copy json</button>
                  <button class="btn subtle" id="downloadSpecBtn">download json</button>
                </div>

                <div class="small" style="margin-top:10px;">
                  note this only builds the specification. next step later is generating code and backtests.
                </div>
              </div>
            </div>
          </div>

          <!-- SETTINGS -->
          <div id="view-settings" class="view hidden">
            <div class="h1">settings</div>
            <div class="p">placeholder. we can add theme toggle, account, and data export later.</div>
            <div class="panel">
              <div style="font-weight:1000;">coming soon</div>
              <div class="small">theme, export, delete account.</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------------- supabase ----------------
    const SUPABASE_URL = "https://oucikdsngvdhimquclcz.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_gMETcAB_TRLGd8hqx48KRA_yXxE7U6v";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        storageKey: "sessionly_auth",
      },
    });

    const $ = (id) => document.getElementById(id);

    async function requireSession(){
      const { data, error } = await sb.auth.getSession();
      if (error) console.error(error);
      const session = data?.session;
      if (!session){
        window.location.replace("./login.html");
        return null;
      }
      return session;
    }

    function setUserUI(session){
      const email = session?.user?.email || "signed in";
      $("userEmail").textContent = email;

      const letter = (email && email[0]) ? email[0].toUpperCase() : "S";
      $("avatarBubble").textContent = letter;
    }

    $("logoutBtn").addEventListener("click", async ()=>{
      try{ await sb.auth.signOut(); }catch(e){}
      window.location.replace("./login.html");
    });

    // ---------------- tabs routing ----------------
    const views = ["home","trades","bot","builder","settings"];

    function showTab(tab){
      if (!views.includes(tab)) tab = "home";

      views.forEach(v=>{
        const el = $("view-" + v);
        if (el) el.classList.toggle("hidden", v !== tab);
      });

      document.querySelectorAll(".tabBtn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });

      const kRoute = $("kRoute");
      if (kRoute) kRoute.textContent = tab;
    }

    function getHashTab(){
      const raw = (window.location.hash || "").replace("#","").trim();
      if (!raw) return "home";
      return raw;
    }

    document.querySelectorAll(".tabBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        window.location.hash = "#" + btn.dataset.tab;
      });
    });

    window.addEventListener("hashchange", async ()=>{
      const tab = getHashTab();
      showTab(tab);

      // when user opens builder the first time, trigger the model intro once
      if (tab === "builder") await ensureBuilderIntro();
      if (tab === "bot") await ensureCoachIntro();
    });

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---------------- shared ai calling ----------------
    function rid(){
      return (crypto?.randomUUID ? crypto.randomUUID() : ("cid_" + Math.random().toString(16).slice(2) + Date.now()));
    }

async function callAiCoach({ message, conversation_id, spec, chat }){
  const sessionRes = await sb.auth.getSession();
  const session = sessionRes?.data?.session;
  if (!session) throw new Error("no session (not logged in)");

  const token = session.access_token;

  const res = await fetch(`${SUPABASE_URL}/functions/v1/ai-coach`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
      "apikey": SUPABASE_ANON_KEY,
    },
    body: JSON.stringify({
      message: message || "",
      conversation_id,
      spec: spec || {},
      chat: Array.isArray(chat) ? chat.slice(-30) : [],
    }),
  });

  const raw = await res.text();

  let data = null;
  try{ data = JSON.parse(raw); }catch(e){}

  if (!res.ok){
    const msg =
      data?.error ||
      data?.detail ||
      data?.message ||
      (typeof raw === "string" && raw.slice(0, 300)) ||
      "request failed";
    throw new Error(`ai-coach ${res.status}: ${msg}`);
  }

  return data || {};
}

    function normalizeReplyText(text){
      return String(text || "").trim() || "ok";
    }

    function computeMissing(spec){
      const s = spec || {};
      const fields = ["goal","market","timeframes","strategy","sessions","risk","filters"];
      return fields.filter(k => !(String(s[k] || "").trim().length));
    }

    // ---------------- AI COACH tab (conversational, spec on right) ----------------
    const COACH_STORE_KEY = "sessionly_ai_coach_state_v2";
    const COACH_CONVO_KEY = "sessionly_ai_coach_convo_v2";

    function getCoachState(){
      try{
        const raw = localStorage.getItem(COACH_STORE_KEY);
        if (!raw) return { chat: [], spec: { goal:"",market:"",timeframes:"",strategy:"",sessions:"",risk:"",filters:"" }, missing: [], questions: [] };
        const p = JSON.parse(raw);
        return {
          chat: Array.isArray(p.chat) ? p.chat : [],
          spec: p.spec || { goal:"",market:"",timeframes:"",strategy:"",sessions:"",risk:"",filters:"" },
          missing: Array.isArray(p.missing) ? p.missing : [],
          questions: Array.isArray(p.questions) ? p.questions : [],
        };
      }catch(e){
        return { chat: [], spec: { goal:"",market:"",timeframes:"",strategy:"",sessions:"",risk:"",filters:"" }, missing: [], questions: [] };
      }
    }

    function setCoachState(state){
      localStorage.setItem(COACH_STORE_KEY, JSON.stringify(state));
    }

    function getCoachConvoId(){
      let id = localStorage.getItem(COACH_CONVO_KEY);
      if (!id){
        id = rid();
        localStorage.setItem(COACH_CONVO_KEY, id);
      }
      return id;
    }

    function renderCoachChat(){
      const state = getCoachState();
      const log = $("coachLog");
      if (!log) return;

      log.innerHTML = "";
      for (const m of state.chat){
        const row = document.createElement("div");
        row.className = "bubbleRow " + (m.role === "user" ? "user" : "ai");
        const b = document.createElement("div");
        b.className = "msgBubble";
        b.textContent = m.text;
        row.appendChild(b);
        log.appendChild(row);
      }
      log.scrollTop = log.scrollHeight;
    }

    function renderCoachSide(){
      const state = getCoachState();
      const spec = state.spec || {};

      const k = $("coachKpis");
      if (k){
        k.innerHTML = "";
        const rows = [
          ["goal", spec.goal],
          ["market", spec.market],
          ["timeframes", spec.timeframes],
          ["strategy", spec.strategy],
          ["sessions", spec.sessions],
          ["risk", spec.risk],
          ["filters", spec.filters],
        ];
        for (const [label, val] of rows){
          const line = document.createElement("div");
          line.className = "kpiLine";
          line.innerHTML = `
            <div><div class="kLabel">${escapeHtml(label)}</div></div>
            <div class="kVal" style="max-width: 220px; overflow:hidden; text-overflow: ellipsis; white-space:nowrap;" title="${escapeHtml(val || "")}">
              ${escapeHtml(val || "—")}
            </div>
          `;
          k.appendChild(line);
        }
      }

      const miss = Array.isArray(state.missing) ? state.missing : computeMissing(spec);
      $("coachRules").textContent = miss.length ? miss.map(x=>"• "+x).join("\n") : "all required inputs collected";

      const qs = Array.isArray(state.questions) ? state.questions : [];
      $("coachQuestions").textContent = qs.length ? qs.map(x=>"• "+x).join("\n") : "no follow up questions";
    }

    function setCoachStatus(t){
      const el = $("coachStatus");
      if (el) el.textContent = t || "";
    }

    async function ensureCoachIntro(){
      const state = getCoachState();
      if (state.chat.length) return;

      // let the model introduce itself once
      setCoachStatus("thinking…");
      try{
        const data = await callAiCoach({
          message: "hello",
          conversation_id: getCoachConvoId(),
          spec: state.spec,
          chat: [],
        });

        const reply = normalizeReplyText(data?.reply);
        const next = {
          chat: [
            { role:"ai", text: reply, ts: Date.now() }
          ],
          spec: { ...(state.spec||{}), ...(data?.spec||{}) },
          missing: Array.isArray(data?.missing) ? data.missing : computeMissing(data?.spec || state.spec),
          questions: Array.isArray(data?.questions) ? data.questions : [],
        };
        setCoachState(next);
      }catch(e){
        // soft fail
        const next = getCoachState();
        next.chat = [{ role:"ai", text:"hey — tell me what you want to build and i’ll guide you", ts: Date.now() }];
        setCoachState(next);
      }finally{
        setCoachStatus("");
        renderCoachChat();
        renderCoachSide();
      }
    }

    $("coachSendBtn").addEventListener("click", async ()=>{
      const inp = $("coachInput");
      const msg = (inp.value || "").trim();
      if (!msg) return;
      inp.value = "";

      const state = getCoachState();
      state.chat.push({ role:"user", text: msg, ts: Date.now() });
      setCoachState(state);
      renderCoachChat();

      setCoachStatus("thinking…");
      try{
        const data = await callAiCoach({
          message: msg,
          conversation_id: getCoachConvoId(),
          spec: state.spec,
          chat: state.chat,
        });

        const next = getCoachState();
        next.spec = { ...(next.spec||{}), ...(data?.spec||{}) };
        next.missing = Array.isArray(data?.missing) ? data.missing : computeMissing(next.spec);
        next.questions = Array.isArray(data?.questions) ? data.questions : [];

        const reply = normalizeReplyText(data?.reply);
        next.chat.push({ role:"ai", text: reply, ts: Date.now() });

        setCoachState(next);
        renderCoachChat();
        renderCoachSide();
catch(err){
      console.error(err);
        const next = getBuilderState(); // or getCoachState() in the other tab
        const msg = String(err?.message || err || "unknown error");
        next.chat.push({ role:"ai", text: msg, ts: Date.now() });
        setBuilderState(next); // or setCoachState(next)
        renderBuilderChat(); // or renderCoachChat()
        setBuilderStatus(msg); // or setCoachStatus(msg)
  }

      }finally{
        setCoachStatus("");
      }
    });

    $("coachInput").addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        $("coachSendBtn").click();
      }
    });

    $("coachResetBtn").addEventListener("click", ()=>{
      localStorage.removeItem(COACH_STORE_KEY);
      localStorage.removeItem(COACH_CONVO_KEY);
      ensureCoachIntro();
    });

    // ---------------- AI BOT BUILDER tab (uses Claude, not scripted) ----------------
    const BUILDER_STORE_KEY = "sessionly_ai_builder_state_v2";
    const BUILDER_CONVO_KEY = "sessionly_ai_builder_convo_v2";

    function getBuilderState(){
      try{
        const raw = localStorage.getItem(BUILDER_STORE_KEY);
        if (!raw) return { chat: [], spec: { goal:"",market:"",timeframes:"",strategy:"",sessions:"",risk:"",filters:"" }, missing: [], questions: [] };
        const p = JSON.parse(raw);
        return {
          chat: Array.isArray(p.chat) ? p.chat : [],
          spec: p.spec || { goal:"",market:"",timeframes:"",strategy:"",sessions:"",risk:"",filters:"" },
          missing: Array.isArray(p.missing) ? p.missing : [],
          questions: Array.isArray(p.questions) ? p.questions : [],
        };
      }catch(e){
        return { chat: [], spec: { goal:"",market:"",timeframes:"",strategy:"",sessions:"",risk:"",filters:"" }, missing: [], questions: [] };
      }
    }

    function setBuilderState(state){
      localStorage.setItem(BUILDER_STORE_KEY, JSON.stringify(state));
    }

    function getBuilderConvoId(){
      let id = localStorage.getItem(BUILDER_CONVO_KEY);
      if (!id){
        id = rid();
        localStorage.setItem(BUILDER_CONVO_KEY, id);
      }
      return id;
    }

    function setBuilderStatus(t){
      const el = $("builderStatus");
      if (el) el.textContent = t || "";
    }

    function renderBuilderChat(){
      const state = getBuilderState();
      const log = $("builderLog");
      if (!log) return;

      log.innerHTML = "";
      for (const m of state.chat){
        const row = document.createElement("div");
        row.className = "bubbleRow " + (m.role === "user" ? "user" : "ai");
        const b = document.createElement("div");
        b.className = "msgBubble";
        b.textContent = m.text;
        row.appendChild(b);
        log.appendChild(row);
      }
      log.scrollTop = log.scrollHeight;
    }

    function renderSpec(){
      const state = getBuilderState();
      const spec = state.spec || {};
      const k = $("specKpis");
      if (!k) return;

      k.innerHTML = "";
      const rows = [
        ["goal", spec.goal],
        ["market", spec.market],
        ["timeframes", spec.timeframes],
        ["strategy", spec.strategy],
        ["sessions", spec.sessions],
        ["risk", spec.risk],
        ["filters", spec.filters],
      ];

      for (const [label, val] of rows){
        const line = document.createElement("div");
        line.className = "kpiLine";
        line.innerHTML = `
          <div><div class="kLabel">${escapeHtml(label)}</div></div>
          <div class="kVal" style="max-width: 220px; overflow:hidden; text-overflow: ellipsis; white-space:nowrap;" title="${escapeHtml(val || "")}">
            ${escapeHtml(val || "—")}
          </div>
        `;
        k.appendChild(line);
      }
    }

    function exportSpecJson(){
      const state = getBuilderState();
      const spec = state.spec || {};
      return {
        product: "sessionly_ai_bot_builder",
        spec_version: "1.0",
        goal: spec.goal || "",
        market: spec.market || "",
        timeframes: spec.timeframes || "",
        strategy: spec.strategy || "",
        sessions: spec.sessions || "",
        risk: spec.risk || "",
        filters: spec.filters || "",
        created_at: new Date().toISOString(),
      };
    }

    async function ensureBuilderIntro(){
      const state = getBuilderState();
      if (state.chat.length) return;

      setBuilderStatus("thinking…");
      try{
        const data = await callAiCoach({
          message: "hello",
          conversation_id: getBuilderConvoId(),
          spec: state.spec,
          chat: [],
        });

        const reply = normalizeReplyText(data?.reply);
        const next = {
          chat: [{ role:"ai", text: reply, ts: Date.now() }],
          spec: { ...(state.spec||{}), ...(data?.spec||{}) },
          missing: Array.isArray(data?.missing) ? data.missing : computeMissing(data?.spec || state.spec),
          questions: Array.isArray(data?.questions) ? data.questions : [],
        };
        setBuilderState(next);
      }catch(e){
        const next = getBuilderState();
        next.chat = [{ role:"ai", text:"hey — tell me what you want to build and i’ll turn it into a bot spec", ts: Date.now() }];
        setBuilderState(next);
      }finally{
        setBuilderStatus("");
        renderBuilderChat();
        renderSpec();
      }
    }

    $("builderSendBtn").addEventListener("click", async ()=>{
      const inp = $("builderInput");
      const msg = (inp.value || "").trim();
      if (!msg) return;
      inp.value = "";

      const state = getBuilderState();
      state.chat.push({ role:"user", text: msg, ts: Date.now() });
      setBuilderState(state);
      renderBuilderChat();

      setBuilderStatus("thinking…");
      try{
        const data = await callAiCoach({
          message: msg,
          conversation_id: getBuilderConvoId(),
          spec: state.spec,
          chat: state.chat,
        });

        const next = getBuilderState();
        next.spec = { ...(next.spec||{}), ...(data?.spec||{}) };
        next.missing = Array.isArray(data?.missing) ? data.missing : computeMissing(next.spec);
        next.questions = Array.isArray(data?.questions) ? data.questions : [];

        const reply = normalizeReplyText(data?.reply);
        next.chat.push({ role:"ai", text: reply, ts: Date.now() });

        setBuilderState(next);
        renderBuilderChat();
        renderSpec();
      }catch(err){
        console.error(err);
        const next = getBuilderState();
        next.chat.push({ role:"ai", text:"something failed. try again", ts: Date.now() });
        setBuilderState(next);
        renderBuilderChat();
      }finally{
        setBuilderStatus("");
      }
    });

    $("builderInput").addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        $("builderSendBtn").click();
      }
    });

    $("builderResetBtn").addEventListener("click", ()=>{
      localStorage.removeItem(BUILDER_STORE_KEY);
      localStorage.removeItem(BUILDER_CONVO_KEY);
      ensureBuilderIntro();
    });

    $("copySpecBtn").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(JSON.stringify(exportSpecJson(), null, 2));
        alert("copied");
      }catch(e){
        alert("could not copy");
      }
    });

    $("downloadSpecBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(exportSpecJson(), null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "sessionly-bot-spec.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ---------------- init ----------------
    (async function init(){
      const session = await requireSession();
      if (!session) return;

      setUserUI(session);

      const tab = getHashTab();
      showTab(tab);

      // init both chats (they will only auto-intro if empty)
      if (tab === "bot") await ensureCoachIntro();
      if (tab === "builder") await ensureBuilderIntro();

      renderCoachChat();
      renderCoachSide();

      renderBuilderChat();
      renderSpec();

      const kSession = $("kSession");
      if (kSession) kSession.textContent = "active";
    })();
  </script>
</body>
</html>
